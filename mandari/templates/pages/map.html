{% extends "base_insight.html" %}
{% load static %}

{% block title %}Karte{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'vendor/leaflet/leaflet.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/leaflet/MarkerCluster.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/leaflet/MarkerCluster.Default.css' %}" />
<style>
    #map {
        height: calc(100vh - 280px);
        min-height: 450px;
        border-radius: 0.75rem;
    }

    /* Leaflet Controls anpassen */
    .leaflet-control-zoom {
        border: none !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
        border-radius: 8px !important;
        overflow: hidden;
    }
    .leaflet-control-zoom a {
        background: white !important;
        color: #374151 !important;
        border: none !important;
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
    }
    .leaflet-control-zoom a:hover {
        background: #f3f4f6 !important;
    }
    .dark .leaflet-control-zoom a {
        background: #374151 !important;
        color: #e5e7eb !important;
    }
    .dark .leaflet-control-zoom a:hover {
        background: #4b5563 !important;
    }

    .leaflet-control-attribution {
        background: rgba(255,255,255,0.85) !important;
        padding: 2px 8px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
    }
    .dark .leaflet-control-attribution {
        background: rgba(31,41,55,0.85) !important;
        color: #9ca3af !important;
    }

    /* Popup Styling */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 0;
    }
    .leaflet-popup-content {
        margin: 0;
        min-width: 220px;
    }
    .dark .leaflet-popup-content-wrapper {
        background: #1f2937;
        color: #f3f4f6;
    }
    .dark .leaflet-popup-tip {
        background: #1f2937;
    }

    /* Marker */
    .custom-marker {
        background: transparent !important;
        border: none !important;
    }
    .marker-dot {
        width: 24px;
        height: 24px;
        background: #6366f1;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(99,102,241,0.4);
    }
    .marker-dot:hover {
        transform: scale(1.15);
    }

    /* Cluster */
    .marker-cluster {
        background: rgba(99,102,241,0.2) !important;
    }
    .marker-cluster div {
        background: #6366f1 !important;
        color: white !important;
        font-weight: 600 !important;
        font-size: 13px !important;
    }

    /* Empty State */
    .map-container.is-empty #map {
        filter: grayscale(0.8) opacity(0.5);
    }
    .empty-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 500;
        pointer-events: none;
    }
    .empty-card {
        background: white;
        padding: 24px 32px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center;
        pointer-events: auto;
    }
    .dark .empty-card {
        background: #1f2937;
    }
</style>
{% endblock %}

{% block content %}
<div>
    <!-- Header (wie andere Insight-Seiten) -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Karte</h1>
        <p class="text-gray-600 dark:text-gray-400">
            {% if active_body %}
                Vorgänge mit Ortsbezug in {{ active_body.get_display_name }}
            {% else %}
                Bitte wählen Sie eine Kommune aus
            {% endif %}
        </p>
    </div>

    {% if active_body %}
    <!-- Info Bar -->
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
            <span class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-primary-500"></span>
                Vorgang mit Ortsbezug
            </span>
            <span id="marker-count" class="hidden">
                · <span class="font-medium text-gray-700 dark:text-gray-300">0</span> Einträge
            </span>
        </div>
        <span class="text-xs text-gray-400">Letzte 4 Wochen</span>
    </div>

    <!-- Map Container -->
    <div id="map-container" class="map-container relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div id="map"></div>

        <!-- Empty Overlay (hidden by default) -->
        <div id="empty-overlay" class="empty-overlay hidden">
            <div class="empty-card">
                <i data-lucide="map-pin-off" class="w-10 h-10 mx-auto text-gray-300 dark:text-gray-600 mb-3"></i>
                <p class="text-gray-900 dark:text-white font-medium mb-1">Keine Vorgänge mit Ortsbezug</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">in den letzten 4 Wochen</p>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Body Selected -->
    <div class="text-center py-16 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
        <i data-lucide="map" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Kommune auswählen</h3>
        <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
            Wählen Sie oben eine Kommune aus, um die Karte mit Vorgängen zu sehen.
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if active_body %}
<script src="{% static 'vendor/leaflet/leaflet.js' %}"></script>
<script src="{% static 'vendor/leaflet/leaflet.markercluster.js' %}"></script>
<script>
(function() {
    const mapEl = document.getElementById('map');
    const container = document.getElementById('map-container');
    const emptyOverlay = document.getElementById('empty-overlay');
    const countEl = document.getElementById('marker-count');

    // Karten-Bounds der Kommune
    {% if map_bounds %}
    const bounds = L.latLngBounds(
        [{{ map_bounds.south }}, {{ map_bounds.west }}],
        [{{ map_bounds.north }}, {{ map_bounds.east }}]
    );
    {% elif map_center %}
    const bounds = null;
    const center = [{{ map_center.lat }}, {{ map_center.lng }}];
    {% else %}
    const bounds = null;
    const center = [51.1657, 10.4515];
    {% endif %}

    // Map initialisieren
    const map = L.map('map', {
        zoomControl: true,
        attributionControl: true
    });

    // Initiale Ansicht
    {% if map_bounds %}
    map.fitBounds(bounds, { padding: [30, 30], maxZoom: 13 });
    {% elif map_center %}
    map.setView(center, 12);
    {% else %}
    map.setView([51.1657, 10.4515], 6);
    {% endif %}

    // Tile Layer (lokaler Proxy)
    L.tileLayer('{% url "insight_core:insight:tile_proxy" z=0 x=0 y=0 %}'.replace('/0/0/0', '/{z}/{x}/{y}'), {
        attribution: '© <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 18
    }).addTo(map);

    // Marker Cluster
    const markers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });

    // Marker Icon
    const markerIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div class="marker-dot"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        popupAnchor: [0, -12]
    });

    // Marker laden
    fetch('{% url "insight_core:insight:map_markers" %}')
        .then(r => r.json())
        .then(data => {
            const features = data.features || [];

            if (features.length === 0) {
                // Keine Marker - Karte ausgrauen
                container.classList.add('is-empty');
                emptyOverlay.classList.remove('hidden');
                return;
            }

            // Marker Count anzeigen
            countEl.querySelector('span').textContent = features.length;
            countEl.classList.remove('hidden');

            // Marker hinzufügen
            features.forEach(f => {
                const [lng, lat] = f.geometry.coordinates;
                const p = f.properties;

                const marker = L.marker([lat, lng], { icon: markerIcon });
                marker.bindPopup(`
                    <div class="p-3">
                        <p class="font-medium text-gray-900 dark:text-white text-sm mb-1">${p.title || 'Vorgang'}</p>
                        ${p.reference ? `<p class="text-xs text-gray-500 font-mono mb-2">${p.reference}</p>` : ''}
                        ${p.location_name ? `<p class="text-xs text-gray-500 mb-2"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${p.location_name}</p>` : ''}
                        <a href="${p.url}" class="text-xs text-primary-600 hover:text-primary-700 font-medium">Details →</a>
                    </div>
                `, { maxWidth: 280 });

                markers.addLayer(marker);
            });

            map.addLayer(markers);

            // Auf Marker zoomen falls vorhanden
            if (markers.getLayers().length > 0) {
                const markerBounds = markers.getBounds();
                map.fitBounds(markerBounds, { padding: [40, 40], maxZoom: 14 });
            }

            // Lucide Icons in Popups initialisieren
            map.on('popupopen', () => {
                if (window.lucide) lucide.createIcons();
            });
        })
        .catch(err => {
            console.error('Map markers error:', err);
        });
})();
</script>
{% endif %}
{% endblock %}
