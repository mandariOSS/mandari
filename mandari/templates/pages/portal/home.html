{% extends "base_insight.html" %}

{% block title %}{% if active_body %}{{ active_body.name }} - {% endif %}Mandari Insight Portal{% endblock %}

{% block meta_description %}Ratsinformationssystem: Gremien, Personen, Vorgänge und Termine transparent einsehen.{% endblock %}

{% block content %}
{% if active_body %}
{# ─── Kommune ausgewählt ─── #}

{# 1. Hero + Search #}
<section class="fade-up mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
        Ratsinformationen {{ active_body.get_display_name }}
    </h1>
    <div class="relative">
        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
        <input type="text" placeholder="Sitzungen, Vorgänge, Personen durchsuchen..."
            hx-get="{% url 'insight_core:insight:search' %}"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#search-results-preview"
            name="q"
            class="w-full pl-12 pr-4 py-3.5 text-base bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all outline-none">
    </div>
    <div id="search-results-preview"></div>
</section>

{# 2. Kommende Sitzungen #}
<section class="fade-up d1 mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">Kommende Sitzungen</h2>
        <a href="{% url 'insight_core:insight:meeting_list' %}" class="text-sm font-semibold text-primary-600 dark:text-primary-400 hover:underline flex items-center gap-1">
            Alle Termine <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </a>
    </div>
    {% if upcoming_meetings %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {% for meeting in upcoming_meetings %}
        <a href="{% url 'insight_core:insight:meeting_detail' meeting.pk %}" class="group block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md hover:border-primary-300 dark:hover:border-primary-600 transition-all p-5">
            <div class="flex items-start gap-4">
                <div class="flex flex-col items-center justify-center flex-shrink-0 w-14 h-14 rounded-xl bg-primary-50 dark:bg-primary-900/20">
                    <span class="text-xl font-extrabold text-primary-600 dark:text-primary-400 leading-none">{{ meeting.start|date:"d" }}</span>
                    <span class="text-[10px] font-bold text-primary-600 dark:text-primary-400 uppercase tracking-wide">{{ meeting.start|date:"M" }}</span>
                </div>
                <div class="min-w-0">
                    <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors line-clamp-2">{{ meeting.get_display_name }}</h3>
                    {% if meeting.start %}
                    <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1 mb-0.5">
                        <i data-lucide="clock" class="w-3 h-3"></i> {{ meeting.start|date:"H:i" }} Uhr
                    </p>
                    {% endif %}
                    {% if meeting.location_name %}
                    <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> {{ meeting.location_name|truncatechars:30 }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-8 text-center">
        <p class="text-gray-500 dark:text-gray-400">Keine anstehenden Sitzungen</p>
    </div>
    {% endif %}
</section>

{# 3. Neueste Vorgänge #}
<section class="fade-up d2 mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">Neueste Vorgänge</h2>
        <a href="{% url 'insight_core:insight:paper_list' %}" class="text-sm font-semibold text-primary-600 dark:text-primary-400 hover:underline flex items-center gap-1">
            Alle <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </a>
    </div>
    {% if recent_papers %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        {% for paper in recent_papers %}
        <a href="{% url 'insight_core:insight:paper_detail' paper.pk %}" class="flex items-center gap-4 px-5 py-3.5 {% if not forloop.last %}border-b border-gray-100 dark:border-gray-700/50{% endif %} hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
            <span class="w-2 h-2 rounded-full bg-primary-500 shadow-[0_0_0_3px_rgba(99,102,241,.12)] flex-shrink-0"></span>
            <span class="text-sm font-medium text-gray-900 dark:text-white flex-1 min-w-0 truncate">{{ paper.name|default:paper.reference }}</span>
            {% if paper.reference %}
            <span class="text-xs text-gray-400 dark:text-gray-500 flex-shrink-0 hidden sm:inline">{{ paper.reference }}</span>
            {% endif %}
            {% if paper.date %}
            <span class="text-xs text-gray-400 dark:text-gray-500 flex-shrink-0">{{ paper.date|date:"d.m." }}</span>
            {% endif %}
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-8 text-center">
        <p class="text-gray-500 dark:text-gray-400">Keine Vorgänge vorhanden</p>
    </div>
    {% endif %}
</section>

{# 4. Quick Stats #}
<section class="fade-up d3 mb-8">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="{% url 'insight_core:insight:organization_list' %}"
            class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 hover:shadow-md hover:border-primary-300 dark:hover:border-primary-600 transition-all text-center group">
            <div class="text-2xl font-bold text-primary-600 dark:text-primary-400 mb-1">{{ stats.organizations }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-primary-600">Gremien</div>
        </a>
        <a href="{% url 'insight_core:insight:person_list' %}"
            class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 hover:shadow-md hover:border-primary-300 dark:hover:border-primary-600 transition-all text-center group">
            <div class="text-2xl font-bold text-primary-600 dark:text-primary-400 mb-1">{{ stats.persons }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-primary-600">Personen</div>
        </a>
        <a href="{% url 'insight_core:insight:paper_list' %}"
            class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 hover:shadow-md hover:border-primary-300 dark:hover:border-primary-600 transition-all text-center group">
            <div class="text-2xl font-bold text-primary-600 dark:text-primary-400 mb-1">{{ stats.papers }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-primary-600">Vorgänge</div>
        </a>
        <a href="{% url 'insight_core:insight:meeting_list' %}"
            class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 hover:shadow-md hover:border-primary-300 dark:hover:border-primary-600 transition-all text-center group">
            <div class="text-2xl font-bold text-primary-600 dark:text-primary-400 mb-1">{{ stats.meetings }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 group-hover:text-primary-600">Sitzungen</div>
        </a>
    </div>
</section>

{% else %}
{# ─── Alle Kommunen Modus ─── #}

<section class="fade-up mb-8">
    <div class="text-center mb-8">
        <span class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300 text-sm font-medium mb-4">
            <i data-lucide="globe" class="w-4 h-4"></i>
            Alle Kommunen
        </span>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
            Mandari Insight Portal
        </h1>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
            Wählen Sie eine Kommune aus, um Ratsinformationen einzusehen
        </p>
    </div>

    {% if available_bodies %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto">
        {% for body in available_bodies %}
        <a href="{% url 'insight_core:insight:set_body' body.id %}"
            class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 hover:shadow-lg hover:border-primary-300 dark:hover:border-primary-700 transition-all group">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900/50 rounded-lg flex items-center justify-center shrink-0">
                    <i data-lucide="landmark" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
                </div>
                <div class="min-w-0">
                    <h3 class="font-semibold text-gray-900 dark:text-white group-hover:text-primary-600 truncate">
                        {{ body.get_display_name }}
                    </h3>
                    {% if body.classification %}
                    <p class="text-sm text-gray-500 dark:text-gray-400 truncate">{{ body.classification }}</p>
                    {% endif %}
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full mx-auto mb-4 flex items-center justify-center">
            <i data-lucide="database" class="w-8 h-8 text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Keine Kommunen verfügbar</h3>
        <p class="text-gray-500 dark:text-gray-400">Es wurden noch keine Kommunen synchronisiert.</p>
    </div>
    {% endif %}

    {% if stats.bodies > 0 %}
    <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
        <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4">Insgesamt verfügbar:</p>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 max-w-3xl mx-auto text-center">
            <div>
                <div class="text-xl font-bold text-gray-700 dark:text-gray-300">{{ stats.bodies }}</div>
                <div class="text-xs text-gray-500">Kommunen</div>
            </div>
            <div>
                <div class="text-xl font-bold text-gray-700 dark:text-gray-300">{{ stats.organizations }}</div>
                <div class="text-xs text-gray-500">Gremien</div>
            </div>
            <div>
                <div class="text-xl font-bold text-gray-700 dark:text-gray-300">{{ stats.persons }}</div>
                <div class="text-xs text-gray-500">Personen</div>
            </div>
            <div>
                <div class="text-xl font-bold text-gray-700 dark:text-gray-300">{{ stats.meetings }}</div>
                <div class="text-xs text-gray-500">Sitzungen</div>
            </div>
            <div>
                <div class="text-xl font-bold text-gray-700 dark:text-gray-300">{{ stats.papers }}</div>
                <div class="text-xs text-gray-500">Vorgänge</div>
            </div>
        </div>
    </div>
    {% endif %}
</section>
{% endif %}
{% endblock %}
