{% extends "work/base_work.html" %}
{% load static %}

{% block page_title %}{{ meeting.title }} bearbeiten{% endblock %}

{% block header_title %}Sitzung bearbeiten{% endblock %}
{% block header_subtitle %}
<p class="work-page-subtitle">{{ meeting.title }}</p>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    <a href="{% url 'work:faction_detail' org_slug=organization.slug meeting_id=meeting.id %}"
       class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
        <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
        Zurück
    </a>
</div>
{% endblock %}

{% block work_content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6" x-data="agendaEditor()">
    <!-- Main Form -->
    <div class="lg:col-span-2 space-y-6">
        <form method="post" id="meeting-form">
            {% csrf_token %}

            <!-- Basic Details -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Sitzungsdetails</h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Titel <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="title" required
                               value="{{ meeting.title }}"
                               class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Datum <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="start_date" required
                                   value="{{ meeting.start|date:'Y-m-d' }}"
                                   class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Uhrzeit <span class="text-red-500">*</span>
                            </label>
                            <input type="time" name="start_time" required
                                   value="{{ meeting.start|time:'H:i' }}"
                                   class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Beschreibung</label>
                        <textarea name="description" rows="3"
                                  class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500"
                                  placeholder="Optionale Hinweise zur Sitzung...">{{ meeting.description|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Location -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6"
                 x-data="{ isVirtual: {{ meeting.is_virtual|yesno:'true,false' }} }">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Ort</h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Physischer Ort</label>
                        <input type="text" name="location"
                               value="{{ meeting.location|default:'' }}"
                               class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500"
                               placeholder="z.B. Fraktionsbüro, Rathaus Raum 203">
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="is_virtual" name="is_virtual" x-model="isVirtual"
                               {% if meeting.is_virtual %}checked{% endif %}
                               class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                        <label for="is_virtual" class="text-sm text-gray-700 dark:text-gray-300">
                            Online-Teilnahme möglich
                        </label>
                    </div>

                    <div x-show="isVirtual" x-transition>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Video-Link</label>
                        <input type="url" name="video_link"
                               value="{{ meeting.video_link|default:'' }}"
                               class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500"
                               placeholder="https://meet.example.com/...">
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Status</h3>

                <div class="flex flex-wrap gap-2">
                    {% for value, label in status_choices %}
                    <label class="flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border
                        {% if meeting.status == value %}
                        border-primary-500 bg-primary-50 dark:bg-primary-900/20
                        {% else %}
                        border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900
                        {% endif %}">
                        <input type="radio" name="status" value="{{ value }}"
                               {% if meeting.status == value %}checked{% endif %}
                               class="text-primary-600">
                        <span class="text-sm {% if meeting.status == value %}text-primary-700 dark:text-primary-300 font-medium{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                            {{ label }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between">
                <a href="{% url 'work:faction_detail' org_slug=organization.slug meeting_id=meeting.id %}"
                   class="text-sm text-gray-500 hover:text-gray-700">
                    Abbrechen
                </a>
                <button type="submit"
                        class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Änderungen speichern
                </button>
            </div>
        </form>
    </div>

    <!-- Sidebar: Agenda -->
    <div class="space-y-6">
        <!-- Public Agenda Items -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-medium text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4 text-primary-600"></i>
                    Öffentlicher Teil
                </h3>
            </div>

            <!-- Sortable Agenda List - Public -->
            <div id="agenda-list-public" class="space-y-2 mb-4">
                {% for item in agenda_items %}
                {% if item.visibility == 'public' %}
                <div class="agenda-item flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg group"
                     data-id="{{ item.id }}" data-visibility="public">
                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move drag-handle"></i>
                    <span class="w-6 h-6 flex-shrink-0 bg-primary-100 dark:bg-primary-900/30 rounded flex items-center justify-center text-xs font-medium text-primary-600 dark:text-primary-400">
                        {{ item.number }}
                    </span>
                    <span class="flex-1 text-sm text-gray-900 dark:text-white truncate">{{ item.title }}</span>
                    <button type="button" @click="deleteItem('{{ item.id }}')"
                            class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                {% endif %}
                {% empty %}
                <p class="text-sm text-gray-500 text-center py-4">Keine öffentlichen Punkte</p>
                {% endfor %}
            </div>

            <!-- Add New Public Item -->
            <form @submit.prevent="addItem('public')" class="flex gap-2">
                <input type="text" x-model="newPublicTitle" required
                       class="flex-1 px-3 py-2 text-sm bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500"
                       placeholder="Neuer öffentlicher Punkt...">
                <button type="submit"
                        class="px-3 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </form>
        </div>

        <!-- Internal/Non-public Agenda Items -->
        <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-medium text-amber-800 dark:text-amber-300 flex items-center gap-2">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                    Nicht-öffentlicher Teil
                </h3>
            </div>

            <!-- Sortable Agenda List - Internal -->
            <div id="agenda-list-internal" class="space-y-2 mb-4">
                {% for item in agenda_items %}
                {% if item.visibility == 'internal' %}
                <div class="agenda-item flex items-center gap-2 p-3 bg-white dark:bg-gray-800 rounded-lg group border border-amber-200 dark:border-amber-800"
                     data-id="{{ item.id }}" data-visibility="internal">
                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move drag-handle"></i>
                    <span class="w-6 h-6 flex-shrink-0 bg-amber-100 dark:bg-amber-900/30 rounded flex items-center justify-center text-xs font-medium text-amber-700 dark:text-amber-400">
                        {{ item.number }}
                    </span>
                    <span class="flex-1 text-sm text-gray-900 dark:text-white truncate">{{ item.title }}</span>
                    <button type="button" @click="deleteItem('{{ item.id }}')"
                            class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Add New Internal Item -->
            <form @submit.prevent="addItem('internal')" class="flex gap-2">
                <input type="text" x-model="newInternalTitle" required
                       class="flex-1 px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-amber-200 dark:border-amber-700 rounded-lg focus:ring-2 focus:ring-amber-500"
                       placeholder="Neuer nicht-öffentlicher Punkt...">
                <button type="submit"
                        class="px-3 py-2 text-sm font-medium text-white bg-amber-600 rounded-lg hover:bg-amber-700">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </form>
        </div>

        <!-- Meeting Info -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Info</h3>

            <dl class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <dt class="text-gray-500">Erstellt von</dt>
                    <dd class="text-gray-900 dark:text-white">{{ meeting.created_by.user.get_display_name }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-gray-500">Erstellt am</dt>
                    <dd class="text-gray-900 dark:text-white">{{ meeting.created_at|date:"d.m.Y" }}</dd>
                </div>
                {% if meeting.schedule %}
                <div class="flex justify-between">
                    <dt class="text-gray-500">Sitzungsplan</dt>
                    <dd class="text-gray-900 dark:text-white">{{ meeting.schedule.name }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>

        <!-- Danger Zone -->
        <div class="bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800 p-6">
            <h3 class="text-lg font-medium text-red-800 dark:text-red-200 mb-2">Gefahrenzone</h3>
            <p class="text-sm text-red-600 dark:text-red-400 mb-4">
                Diese Aktion kann nicht rückgängig gemacht werden.
            </p>
            <button type="button" @click="confirmDelete = true"
                    class="w-full px-4 py-2 text-sm font-medium text-red-700 dark:text-red-300 bg-white dark:bg-gray-800 border border-red-300 dark:border-red-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30">
                Sitzung löschen
            </button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="confirmDelete" x-transition
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="confirmDelete = false"
         @keydown.escape.window="confirmDelete = false">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-xl" @click.stop>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Sitzung löschen?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                Möchten Sie die Sitzung "{{ meeting.title }}" wirklich löschen?
                Alle zugehörigen Daten (Tagesordnung, Anwesenheit, Protokoll) werden ebenfalls gelöscht.
            </p>
            <div class="flex justify-end gap-3">
                <button type="button" @click="confirmDelete = false"
                        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                    Abbrechen
                </button>
                <form method="post" action="{% url 'work:faction_detail' org_slug=organization.slug meeting_id=meeting.id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium rounded-lg bg-red-600 dark:bg-red-700 text-white hover:bg-red-700 dark:hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Endgültig löschen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'vendor/sortablejs/Sortable.min.js' %}"></script>
<script>
function agendaEditor() {
    return {
        newPublicTitle: '',
        newInternalTitle: '',
        confirmDelete: false,

        init() {
            this.initSortable();
        },

        initSortable() {
            // Public list
            const publicEl = document.getElementById('agenda-list-public');
            if (publicEl) {
                new Sortable(publicEl, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: () => this.reorderAllItems()
                });
            }

            // Internal list
            const internalEl = document.getElementById('agenda-list-internal');
            if (internalEl) {
                new Sortable(internalEl, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: () => this.reorderAllItems()
                });
            }
        },

        async addItem(visibility) {
            const title = visibility === 'internal' ? this.newInternalTitle : this.newPublicTitle;
            if (!title.trim()) return;

            const formData = new FormData();
            formData.append('action', 'add');
            formData.append('title', title);
            formData.append('visibility', visibility);

            const response = await fetch('{% url "work:faction_agenda" org_slug=organization.slug meeting_id=meeting.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const data = await response.json();
                alert(data.error || 'Fehler beim Hinzufügen');
            }
        },

        async deleteItem(itemId) {
            if (!confirm('Tagesordnungspunkt löschen?')) return;

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('item_id', itemId);

            const response = await fetch('{% url "work:faction_agenda" org_slug=organization.slug meeting_id=meeting.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                location.reload();
            }
        },

        async reorderAllItems() {
            // Collect all items from both lists in order
            const publicItems = Array.from(document.querySelectorAll('#agenda-list-public .agenda-item'))
                .map(item => item.dataset.id);
            const internalItems = Array.from(document.querySelectorAll('#agenda-list-internal .agenda-item'))
                .map(item => item.dataset.id);

            const order = [...publicItems, ...internalItems];

            const formData = new FormData();
            formData.append('action', 'reorder');
            formData.append('order', JSON.stringify(order));

            await fetch('{% url "work:faction_agenda" org_slug=organization.slug meeting_id=meeting.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
        }
    }
}
</script>
{% endblock %}
