{% extends "work/base_work.html" %}
{% load permission_tags %}

{% block page_title %}Fraktionssitzungen{% endblock %}

{% block header_title %}Fraktionssitzungen{% endblock %}
{% block header_subtitle %}
<p class="work-page-subtitle">{{ stats.total }} Sitzungen · {{ stats.upcoming }} anstehend</p>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    {% if membership|has_perm:"faction.manage" %}
    <a href="{% url 'work:organization_faction_settings' org_slug=organization.slug %}"
       class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"
       title="Einstellungen">
        <i data-lucide="settings" class="w-4 h-4"></i>
    </a>
    <a href="{% url 'work:faction_schedules' org_slug=organization.slug %}"
       class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
        <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
        Sitzungspläne
    </a>
    {% endif %}
    {% if membership|has_perm:"faction.create" %}
    <a href="{% url 'work:faction_create' org_slug=organization.slug %}"
       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Neue Sitzung
    </a>
    {% endif %}
</div>
{% endblock %}

{% block work_content %}
<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                <i data-lucide="calendar-clock" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.upcoming }}</div>
                <div class="text-sm text-gray-500">Anstehend</div>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total }}</div>
                <div class="text-sm text-gray-500">Gesamt</div>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                <i data-lucide="file-text" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.pending_protocol }}</div>
                <div class="text-sm text-gray-500">Offene Protokolle</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 mb-6">
    <form method="get" class="flex flex-wrap items-center gap-4">
        <!-- Search -->
        <div class="flex-1 min-w-[200px]">
            <div class="relative">
                <input type="text" name="q" value="{{ search_query|default:'' }}"
                       placeholder="Sitzung suchen..."
                       class="w-full px-4 py-2.5 pl-10 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <!-- Time Filter -->
        <div class="flex items-center bg-gray-100 dark:bg-gray-900 rounded-lg p-1">
            <a href="?time=upcoming{% if search_query %}&q={{ search_query }}{% endif %}"
               class="px-4 py-1.5 text-sm font-medium rounded-md {% if selected_time == 'upcoming' %}bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900{% endif %}">
                Anstehend
            </a>
            <a href="?time=past{% if search_query %}&q={{ search_query }}{% endif %}"
               class="px-4 py-1.5 text-sm font-medium rounded-md {% if selected_time == 'past' %}bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900{% endif %}">
                Vergangen
            </a>
            <a href="?time=all{% if search_query %}&q={{ search_query }}{% endif %}"
               class="px-4 py-1.5 text-sm font-medium rounded-md {% if selected_time == 'all' %}bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900{% endif %}">
                Alle
            </a>
        </div>

        <!-- Status Filter -->
        <select name="status" onchange="this.form.submit()"
                class="px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
            <option value="">Alle Status</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<!-- Meetings List -->
<div class="space-y-4">
    {% for meeting in meetings %}
    <a href="{% url 'work:faction_detail' org_slug=organization.slug meeting_id=meeting.id %}"
       class="block bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5 hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
        <div class="flex items-start justify-between">
            <div class="flex items-start gap-4">
                <!-- Date Badge -->
                <div class="flex-shrink-0 w-14 text-center">
                    <div class="text-3xl font-bold text-gray-900 dark:text-white">{{ meeting.start|date:"d" }}</div>
                    <div class="text-xs text-gray-500 uppercase">{{ meeting.start|date:"M" }}</div>
                </div>

                <div>
                    <div class="flex items-center gap-2">
                        <h3 class="font-medium text-gray-900 dark:text-white">{{ meeting.title }}</h3>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                            {% if meeting.status == 'draft' %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400
                            {% elif meeting.status == 'planned' %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300
                            {% elif meeting.status == 'invited' %}bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300
                            {% elif meeting.status == 'ongoing' %}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300
                            {% elif meeting.status == 'completed' %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400
                            {% else %}bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300{% endif %}">
                            {{ meeting.get_status_display }}
                        </span>
                    </div>
                    <div class="flex items-center gap-4 mt-1 text-sm text-gray-500">
                        <span class="flex items-center gap-1">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            {{ meeting.start|time:"H:i" }} Uhr
                        </span>
                        {% if meeting.location %}
                        <span class="flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                            {{ meeting.location }}
                        </span>
                        {% endif %}
                        {% if meeting.is_virtual %}
                        <span class="flex items-center gap-1 text-blue-500">
                            <i data-lucide="video" class="w-4 h-4"></i>
                            Online
                        </span>
                        {% endif %}
                    </div>
                    {% if meeting.attendee_count > 0 %}
                    <p class="mt-1 text-sm text-gray-500">
                        {{ meeting.attendee_count }} Teilnehmer bestätigt
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="flex items-center gap-2">
                {% if meeting.status == 'completed' and not meeting.protocol_approved %}
                <span class="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 text-xs rounded-full">
                    Protokoll offen
                </span>
                {% endif %}
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
            </div>
        </div>
    </a>
    {% empty %}
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-12 text-center">
        <div class="w-16 h-16 mx-auto mb-4 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
            <i data-lucide="users" class="w-8 h-8 text-purple-500 dark:text-purple-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Keine Fraktionssitzungen</h3>
        <p class="text-gray-500 dark:text-gray-400 max-w-sm mx-auto">
            {% if search_query or selected_status %}
            Keine Sitzungen mit diesen Filterkriterien gefunden.
            {% else %}
            Planen Sie Ihre erste Fraktionssitzung, um mit der Zusammenarbeit zu beginnen.
            {% endif %}
        </p>
        {% if not search_query and not selected_status %}
        <a href="{% url 'work:faction_create' org_slug=organization.slug %}"
           class="inline-flex items-center gap-2 mt-6 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Sitzung planen
        </a>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if meetings.has_other_pages %}
<div class="mt-6 flex items-center justify-center">
    <nav class="flex items-center gap-1">
        {% if meetings.has_previous %}
        <a href="?page={{ meetings.previous_page_number }}{% if selected_time %}&time={{ selected_time }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
           class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </a>
        {% endif %}

        <span class="px-4 py-2 text-sm text-gray-500">
            Seite {{ meetings.number }} von {{ meetings.paginator.num_pages }}
        </span>

        {% if meetings.has_next %}
        <a href="?page={{ meetings.next_page_number }}{% if selected_time %}&time={{ selected_time }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
           class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </a>
        {% endif %}
    </nav>
</div>
{% endif %}
{% endblock %}
