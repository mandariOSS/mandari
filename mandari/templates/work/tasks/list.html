{% extends "work/base_work.html" %}
{% load static %}

{% block page_title %}Aufgaben{% endblock %}

{% block header_title %}Aufgaben{% endblock %}
{% block header_subtitle %}
<p class="work-page-subtitle">
    {{ stats.total }} Aufgaben · {{ stats.todo }} offen · {{ stats.in_progress }} in Arbeit
    {% if stats.overdue > 0 %}
    <span class="text-red-600 dark:text-red-400">· {{ stats.overdue }} überfällig</span>
    {% endif %}
</p>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    <button type="button" onclick="document.getElementById('import-modal').showModal()"
            class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
        <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
        Importieren
    </button>
    <a href="{% url 'work:task_create' org_slug=organization.slug %}"
       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Neue Aufgabe
    </a>
</div>
{% endblock %}

{% block work_content %}
<div x-data="kanbanBoard()">
    <!-- Filters -->
    <div class="mb-6 flex flex-wrap items-center gap-4">
        <div class="flex items-center bg-gray-100 dark:bg-gray-900 rounded-lg p-1">
            <a href="?view=my{% if show_completed %}&completed=1{% endif %}"
               class="px-4 py-1.5 text-sm font-medium rounded-md {% if view_mode == 'my' %}bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %}">
                Meine Aufgaben
            </a>
            <a href="?view=all{% if show_completed %}&completed=1{% endif %}"
               class="px-4 py-1.5 text-sm font-medium rounded-md {% if view_mode == 'all' %}bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %}">
                Alle Aufgaben
            </a>
        </div>

        <!-- Search -->
        <div class="flex-1 max-w-xs">
            <form method="get" class="relative">
                <input type="hidden" name="view" value="{{ view_mode }}">
                <input type="text" name="q" value="{{ search_query|default:'' }}"
                       placeholder="Aufgaben suchen..."
                       class="w-full px-4 py-2 pl-10 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </form>
        </div>

        <!-- Priority Filter -->
        <select onchange="window.location.href=this.value"
                class="px-4 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
            <option value="?view={{ view_mode }}" {% if not priority_filter %}selected{% endif %}>Alle Prioritäten</option>
            {% for value, label in priority_choices %}
            <option value="?view={{ view_mode }}&priority={{ value }}" {% if priority_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>

        <!-- Show Completed Toggle -->
        <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
            <input type="checkbox" onchange="window.location.href='?view={{ view_mode }}&completed=' + (this.checked ? '1' : '0')"
                   {% if show_completed %}checked{% endif %}
                   class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
            Erledigte anzeigen
        </label>
    </div>

    <!-- Kanban Board -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- TODO Column -->
        <div class="kanban-column">
            <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-blue-500">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/40 rounded-lg flex items-center justify-center">
                        <i data-lucide="circle" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900 dark:text-white">Zu erledigen</h3>
                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ todo_tasks|length }} Aufgaben</span>
                    </div>
                </div>
            </div>

            <div id="column-todo" class="space-y-3 min-h-[200px] p-3 bg-blue-50/50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900/30"
                 data-status="todo">
                {% for task in todo_tasks %}
                {% include "work/tasks/_card.html" %}
                {% empty %}
                <div class="text-center py-8">
                    <div class="w-12 h-12 mx-auto mb-3 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                        <i data-lucide="inbox" class="w-6 h-6 text-blue-400 dark:text-blue-500"></i>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Keine Aufgaben</p>
                </div>
                {% endfor %}
            </div>

            <!-- Quick Add -->
            <form class="mt-3" @submit.prevent="quickAdd('todo', $event)">
                <div class="flex gap-2">
                    <input type="text" name="title" placeholder="Neue Aufgabe..."
                           class="flex-1 px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <button type="submit"
                            class="px-3 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- In Progress Column -->
        <div class="kanban-column">
            <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-amber-500">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-amber-100 dark:bg-amber-900/40 rounded-lg flex items-center justify-center">
                        <i data-lucide="loader" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900 dark:text-white">In Bearbeitung</h3>
                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ in_progress_tasks|length }} Aufgaben</span>
                    </div>
                </div>
            </div>

            <div id="column-in_progress" class="space-y-3 min-h-[200px] p-3 bg-amber-50/50 dark:bg-amber-900/10 rounded-xl border border-amber-100 dark:border-amber-900/30"
                 data-status="in_progress">
                {% for task in in_progress_tasks %}
                {% include "work/tasks/_card.html" %}
                {% empty %}
                <div class="text-center py-8">
                    <div class="w-12 h-12 mx-auto mb-3 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                        <i data-lucide="loader" class="w-6 h-6 text-amber-400 dark:text-amber-500"></i>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Keine aktiven Aufgaben</p>
                </div>
                {% endfor %}
            </div>

            <!-- Quick Add -->
            <form class="mt-3" @submit.prevent="quickAdd('in_progress', $event)">
                <div class="flex gap-2">
                    <input type="text" name="title" placeholder="Neue Aufgabe..."
                           class="flex-1 px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <button type="submit"
                            class="px-3 py-2 text-sm font-medium text-white bg-amber-600 rounded-lg hover:bg-amber-700">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Done Column -->
        <div class="kanban-column">
            <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-green-500">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-green-100 dark:bg-green-900/40 rounded-lg flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-4 h-4 text-green-600 dark:text-green-400"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900 dark:text-white">Erledigt</h3>
                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ done_tasks|length }}{% if not show_completed %}+{% endif %} Aufgaben</span>
                    </div>
                </div>
            </div>

            <div id="column-done" class="space-y-3 min-h-[200px] p-3 bg-green-50/50 dark:bg-green-900/10 rounded-xl border border-green-100 dark:border-green-900/30"
                 data-status="done">
                {% for task in done_tasks %}
                {% include "work/tasks/_card.html" %}
                {% empty %}
                <div class="text-center py-8">
                    <div class="w-12 h-12 mx-auto mb-3 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-400 dark:text-green-500"></i>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Noch nichts erledigt</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <dialog id="import-modal" class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-2xl w-full shadow-xl backdrop:bg-black/50">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Aufgaben aus Protokollen importieren</h3>
            <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div x-data="{ items: [], loading: true, selected: [] }" x-init="loadImportItems()">
            <div x-show="loading" class="py-8 text-center text-gray-500">
                <i data-lucide="loader-2" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                Lade Protokoll-Aufgaben...
            </div>

            <div x-show="!loading && items.length === 0" class="py-8 text-center text-gray-500">
                <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                Keine offenen Protokoll-Aufgaben gefunden.
            </div>

            <div x-show="!loading && items.length > 0" class="space-y-3 max-h-96 overflow-y-auto">
                <template x-for="item in items" :key="item.id">
                    <label class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800">
                        <input type="checkbox" x-model="selected" :value="item.id"
                               class="mt-1 w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                        <div class="flex-1">
                            <p class="text-sm text-gray-900 dark:text-white" x-text="item.content"></p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span x-text="item.meeting"></span> ·
                                <span x-text="item.meeting_date"></span>
                                <template x-if="item.assignee">
                                    <span> · <span x-text="item.assignee"></span></span>
                                </template>
                            </p>
                        </div>
                    </label>
                </template>
            </div>

            <div x-show="!loading && items.length > 0" class="mt-4 flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                <span class="text-sm text-gray-500" x-text="`${selected.length} ausgewählt`"></span>
                <div class="flex gap-3">
                    <button type="button" onclick="this.closest('dialog').close()"
                            class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900">
                        Abbrechen
                    </button>
                    <button type="button" @click="importSelected()"
                            :disabled="selected.length === 0"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 disabled:opacity-50">
                        Importieren
                    </button>
                </div>
            </div>
        </div>
    </dialog>
</div>

<script src="{% static 'vendor/sortablejs/Sortable.min.js' %}"></script>
<script>
function kanbanBoard() {
    return {
        init() {
            this.initSortable();
        },

        initSortable() {
            ['todo', 'in_progress', 'done'].forEach(status => {
                const el = document.getElementById(`column-${status}`);
                if (!el) return;

                new Sortable(el, {
                    group: 'tasks',
                    animation: 150,
                    ghostClass: 'opacity-50',
                    dragClass: 'shadow-lg',
                    onEnd: (evt) => {
                        const taskId = evt.item.dataset.id;
                        const newStatus = evt.to.dataset.status;
                        const newPosition = evt.newIndex;
                        this.moveTask(taskId, newStatus, newPosition);
                    }
                });
            });
        },

        async moveTask(taskId, status, position) {
            await fetch('{% url "work:tasks_api" org_slug=organization.slug %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    task_id: taskId,
                    status: status,
                    position: position
                })
            });
        },

        async quickAdd(status, event) {
            const form = event.target;
            const input = form.querySelector('input[name="title"]');
            const title = input.value.trim();

            if (!title) return;

            const formData = new FormData();
            formData.append('action', 'quick_add');
            formData.append('title', title);
            formData.append('status', status);

            const response = await fetch('{% url "work:tasks_api" org_slug=organization.slug %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                location.reload();
            }
        }
    }
}

async function loadImportItems() {
    const response = await fetch('{% url "work:tasks_import" org_slug=organization.slug %}');
    const data = await response.json();
    this.items = data.items;
    this.loading = false;
}

async function importSelected() {
    if (this.selected.length === 0) return;

    const formData = new FormData();
    this.selected.forEach(id => formData.append('entry_ids[]', id));

    const response = await fetch('{% url "work:tasks_import" org_slug=organization.slug %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    });

    if (response.ok) {
        const data = await response.json();
        document.getElementById('import-modal').close();
        location.reload();
    }
}
</script>
{% endblock %}
