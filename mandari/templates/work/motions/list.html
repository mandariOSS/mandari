{% extends "work/base_work.html" %}

{% block page_title %}Dokumente{% endblock %}

{% block header_title %}Dokumente{% endblock %}
{% block header_subtitle %}
<p class="work-page-subtitle">{{ stats.total }} Dokumente · {{ stats.draft }} Entwürfe</p>
{% endblock %}

{% block header_actions %}
<a href="{% url 'work:motion_trash' org_slug=organization.slug %}"
   class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
    <i data-lucide="trash-2" class="w-4 h-4"></i>
    Papierkorb
</a>
<a href="{% url 'work:motion_import' org_slug=organization.slug %}"
   class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
    <i data-lucide="upload" class="w-4 h-4"></i>
    PDF importieren
</a>
<a href="{% url 'work:motion_create' org_slug=organization.slug %}"
   class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
    <i data-lucide="plus" class="w-4 h-4"></i>
    Neues Dokument
</a>
{% endblock %}

{% block work_content %}
<div x-data="documentManager()">
    <!-- Filters & View Toggle -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 mb-6">
        <form method="get" class="flex flex-wrap items-center gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <div class="relative">
                    <input type="text" name="q" value="{{ search_query|default:'' }}"
                           placeholder="Dokument suchen..."
                           class="w-full px-4 py-2.5 pl-10 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- Type Filter -->
            <select name="type" onchange="this.form.submit()"
                    class="px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                <option value="">Alle Typen</option>
                {% for doc_type in document_types %}
                <option value="{{ doc_type.id }}" {% if selected_type == doc_type.id|stringformat:"s" %}selected{% endif %}>{{ doc_type.name }}</option>
                {% endfor %}
                <option disabled>---</option>
                {% for value, label in type_choices %}
                <option value="{{ value }}" {% if selected_type == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <!-- Status Filter -->
            <select name="status" onchange="this.form.submit()"
                    class="px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500">
                <option value="">Alle Status</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <!-- My Motions -->
            <label class="inline-flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="mine" value="1" {% if filter_mine %}checked{% endif %}
                       onchange="this.form.submit()"
                       class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="text-sm text-gray-600 dark:text-gray-400">Nur meine</span>
            </label>

            <!-- View Toggle -->
            <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-900 rounded-lg p-1">
                <button type="button"
                        @click="setViewMode('grid')"
                        :class="viewMode === 'grid' ? 'bg-white dark:bg-gray-700 shadow-sm' : 'hover:bg-white/50 dark:hover:bg-gray-700/50'"
                        class="p-2 rounded-md transition-colors">
                    <i data-lucide="grid-3x3" class="w-4 h-4" :class="viewMode === 'grid' ? 'text-primary-600' : 'text-gray-500'"></i>
                </button>
                <button type="button"
                        @click="setViewMode('list')"
                        :class="viewMode === 'list' ? 'bg-white dark:bg-gray-700 shadow-sm' : 'hover:bg-white/50 dark:hover:bg-gray-700/50'"
                        class="p-2 rounded-md transition-colors">
                    <i data-lucide="list" class="w-4 h-4" :class="viewMode === 'list' ? 'text-primary-600' : 'text-gray-500'"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Grid View -->
    <div x-show="viewMode === 'grid'" x-cloak class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        {% for motion in motions %}
        <a href="{% url 'work:motion_detail' org_slug=organization.slug motion_id=motion.id %}"
           class="group bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 hover:border-primary-300 dark:hover:border-primary-700 hover:shadow-lg transition-all">
            <!-- Document Icon -->
            <div class="aspect-[4/3] bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden">
                <i data-lucide="{{ motion.get_type_icon }}"
                   class="w-12 h-12
                    {% if motion.status == 'draft' %}text-gray-400
                    {% elif motion.status == 'review' %}text-amber-500
                    {% elif motion.status == 'approved' %}text-green-500
                    {% elif motion.status == 'submitted' %}text-blue-500
                    {% elif motion.status == 'completed' %}text-purple-500
                    {% elif motion.status == 'rejected' %}text-red-500
                    {% else %}text-gray-400{% endif %}"></i>

                <!-- Visibility Badge -->
                <div class="absolute top-2 right-2">
                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full {{ motion.get_visibility_badge_class }}">
                        <i data-lucide="{{ motion.get_visibility_icon }}" class="w-3 h-3"></i>
                    </span>
                </div>

                <!-- Hover Actions -->
                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                    <button type="button"
                            @click.prevent="openShareModal('{{ motion.id }}', '{{ motion.title|escapejs }}', '{{ motion.visibility }}')"
                            class="p-2 bg-white rounded-full shadow-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="share-2" class="w-4 h-4 text-gray-700"></i>
                    </button>
                    <a href="{% url 'work:motion_export' org_slug=organization.slug motion_id=motion.id %}?format=pdf"
                       @click.stop
                       class="p-2 bg-white rounded-full shadow-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="download" class="w-4 h-4 text-gray-700"></i>
                    </a>
                </div>
            </div>

            <!-- Title & Meta -->
            <h3 class="font-medium text-gray-900 dark:text-white text-sm truncate group-hover:text-primary-600">
                {{ motion.title }}
            </h3>
            <div class="flex items-center gap-2 mt-1">
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium
                    {% if motion.status == 'draft' %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400
                    {% elif motion.status == 'review' %}bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300
                    {% elif motion.status == 'approved' %}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300
                    {% elif motion.status == 'submitted' %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300
                    {% elif motion.status == 'completed' %}bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300
                    {% elif motion.status == 'rejected' %}bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300
                    {% else %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
                    {{ motion.get_status_display }}
                </span>
            </div>
            <p class="text-xs text-gray-500 mt-2">
                {{ motion.updated_at|timesince }}
            </p>
        </a>
        {% empty %}
        <div class="col-span-full">
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 px-5 py-12 text-center">
                <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                    <i data-lucide="file-text" class="w-8 h-8 text-green-500 dark:text-green-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Keine Dokumente vorhanden</h3>
                <p class="text-gray-500 dark:text-gray-400 max-w-sm mx-auto">
                    {% if search_query or selected_status or selected_type or filter_mine %}
                    Keine Dokumente mit diesen Filterkriterien gefunden.
                    {% else %}
                    Erstellen Sie Ihr erstes Dokument, um loszulegen.
                    {% endif %}
                </p>
                {% if not search_query and not selected_status and not selected_type and not filter_mine %}
                <div class="flex items-center justify-center gap-3 mt-6">
                    <a href="{% url 'work:motion_import' org_slug=organization.slug %}"
                       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        PDF importieren
                    </a>
                    <a href="{% url 'work:motion_create' org_slug=organization.slug %}"
                       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Neues Dokument
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- DEBUG: Show count -->
    <div class="bg-yellow-100 p-4 mb-4 rounded">
        <strong>DEBUG:</strong> motions count = {{ motions|length }},
        stats.total = {{ stats.total }},
        selected_type = "{{ selected_type }}",
        selected_status = "{{ selected_status }}",
        search_query = "{{ search_query }}",
        filter_mine = {{ filter_mine|yesno:"true,false" }}
        <br><strong>Alpine viewMode:</strong> <span x-text="viewMode"></span>
    </div>

    <!-- DEBUG: List documents outside of x-show -->
    <div class="bg-green-100 p-4 mb-4 rounded">
        <strong>DEBUG Documents (outside x-show):</strong>
        <ul>
        {% for motion in motions %}
            <li>{{ forloop.counter }}. {{ motion.title }} (ID: {{ motion.id }}, Status: {{ motion.status }})</li>
        {% empty %}
            <li>NO DOCUMENTS IN LOOP</li>
        {% endfor %}
        </ul>
    </div>

    <!-- List View (default - no x-cloak so it shows even if Alpine fails) -->
    <div x-show="viewMode === 'list'" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="divide-y divide-gray-100 dark:divide-gray-700">
            {% for motion in motions %}
            <!-- DEBUG: Loop iteration {{ forloop.counter }} - Motion ID: {{ motion.id }}, Title: {{ motion.title }} -->
            <div class="bg-red-200 p-2">DEBUG ITEM: {{ motion.title }} ({{ motion.id }})</div>
            <div class="group relative">
                <a href="{% url 'work:motion_detail' org_slug=organization.slug motion_id=motion.id %}"
                   class="block px-5 py-4 hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
                    <div class="flex items-start gap-4">
                        <!-- Icon -->
                        <div class="flex-shrink-0 p-2 rounded-lg
                            {% if motion.status == 'draft' %}bg-gray-100 dark:bg-gray-700
                            {% elif motion.status == 'review' %}bg-amber-100 dark:bg-amber-900/30
                            {% elif motion.status == 'approved' %}bg-green-100 dark:bg-green-900/30
                            {% elif motion.status == 'submitted' %}bg-blue-100 dark:bg-blue-900/30
                            {% elif motion.status == 'completed' %}bg-purple-100 dark:bg-purple-900/30
                            {% elif motion.status == 'rejected' %}bg-red-100 dark:bg-red-900/30
                            {% else %}bg-gray-100 dark:bg-gray-700{% endif %}">
                            <i data-lucide="{{ motion.get_type_icon }}"
                               class="w-5 h-5
                                {% if motion.status == 'draft' %}text-gray-500
                                {% elif motion.status == 'review' %}text-amber-600 dark:text-amber-400
                                {% elif motion.status == 'approved' %}text-green-600 dark:text-green-400
                                {% elif motion.status == 'submitted' %}text-blue-600 dark:text-blue-400
                                {% elif motion.status == 'completed' %}text-purple-600 dark:text-purple-400
                                {% elif motion.status == 'rejected' %}text-red-600 dark:text-red-400
                                {% else %}text-gray-500{% endif %}"></i>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <h3 class="font-medium text-gray-900 dark:text-white truncate group-hover:text-primary-600">{{ motion.title }}</h3>
                                <!-- Visibility Badge -->
                                <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs {{ motion.get_visibility_badge_class }}">
                                    <i data-lucide="{{ motion.get_visibility_icon }}" class="w-3 h-3"></i>
                                </span>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                    {% if motion.status == 'draft' %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400
                                    {% elif motion.status == 'review' %}bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300
                                    {% elif motion.status == 'approved' %}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300
                                    {% elif motion.status == 'submitted' %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300
                                    {% elif motion.status == 'completed' %}bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300
                                    {% elif motion.status == 'rejected' %}bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300
                                    {% else %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
                                    {{ motion.get_status_display }}
                                </span>
                                <span class="text-xs text-gray-500">{{ motion.get_type_display }}</span>
                                <span class="text-xs text-gray-500">·</span>
                                <span class="text-xs text-gray-500">{{ motion.author.user.get_display_name }}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">
                                Zuletzt bearbeitet {{ motion.updated_at|timesince }}
                            </p>
                        </div>

                        <!-- Actions (visible on hover) -->
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button type="button"
                                    @click.prevent="openShareModal('{{ motion.id }}', '{{ motion.title|escapejs }}', '{{ motion.visibility }}')"
                                    class="p-2 text-gray-400 hover:text-primary-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                            <a href="{% url 'work:motion_export' org_slug=organization.slug motion_id=motion.id %}?format=pdf"
                               @click.stop
                               class="p-2 text-gray-400 hover:text-primary-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>

                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>
                    </div>
                </a>
            </div>
            {% empty %}
            <div class="px-5 py-12 text-center">
                <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                    <i data-lucide="file-text" class="w-8 h-8 text-green-500 dark:text-green-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Keine Dokumente vorhanden</h3>
                <p class="text-gray-500 dark:text-gray-400 max-w-sm mx-auto">
                    {% if search_query or selected_status or selected_type or filter_mine %}
                    Keine Dokumente mit diesen Filterkriterien gefunden.
                    {% else %}
                    Erstellen Sie Ihr erstes Dokument, um loszulegen.
                    {% endif %}
                </p>
                {% if not search_query and not selected_status and not selected_type and not filter_mine %}
                <div class="flex items-center justify-center gap-3 mt-6">
                    <a href="{% url 'work:motion_import' org_slug=organization.slug %}"
                       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        PDF importieren
                    </a>
                    <a href="{% url 'work:motion_create' org_slug=organization.slug %}"
                       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Neues Dokument
                    </a>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if motions.has_other_pages %}
        <div class="px-5 py-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-500">
                    Zeige {{ motions.start_index }}-{{ motions.end_index }} von {{ paginator.count }}
                </p>
                <nav class="flex items-center gap-1">
                    {% if motions.has_previous %}
                    <a href="?page={{ motions.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if filter_mine %}&mine=1{% endif %}"
                       class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </a>
                    {% endif %}

                    {% for num in motions.paginator.page_range %}
                    {% if motions.number == num %}
                    <span class="px-3 py-2 bg-primary-100 dark:bg-primary-900 text-primary-600 dark:text-primary-400 rounded-lg font-medium text-sm">{{ num }}</span>
                    {% elif num > motions.number|add:'-3' and num < motions.number|add:'3' %}
                    <a href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if filter_mine %}&mine=1{% endif %}"
                       class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">{{ num }}</a>
                    {% endif %}
                    {% endfor %}

                    {% if motions.has_next %}
                    <a href="?page={{ motions.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if filter_mine %}&mine=1{% endif %}"
                       class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Share Modal -->
    {% include "work/motions/partials/_share_modal.html" %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function documentManager() {
    return {
        viewMode: 'list',
        showShareModal: false,
        shareMotionId: null,
        shareMotionTitle: '',
        shareVisibility: 'private',
        addUserEmail: '',

        init() {
            // Load viewMode from localStorage with validation
            const stored = localStorage.getItem('docViewMode');
            if (stored === 'grid' || stored === 'list') {
                this.viewMode = stored;
            } else {
                // Default to list and save it
                this.viewMode = 'list';
                localStorage.setItem('docViewMode', 'list');
            }
        },

        setViewMode(mode) {
            this.viewMode = mode;
            localStorage.setItem('docViewMode', mode);
        },

        openShareModal(motionId, title, visibility) {
            this.shareMotionId = motionId;
            this.shareMotionTitle = title;
            this.shareVisibility = visibility;
            this.showShareModal = true;
        },

        closeShareModal() {
            this.showShareModal = false;
            this.shareMotionId = null;
            this.shareMotionTitle = '';
            this.addUserEmail = '';
        }
    }
}
</script>
{% endblock %}
