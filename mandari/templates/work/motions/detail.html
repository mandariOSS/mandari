{% extends "work/base_work.html" %}
{% load humanize %}

{% block page_title %}{{ motion.title }}{% endblock %}

{% block header_title %}{{ motion.title }}{% endblock %}
{% block header_subtitle %}
<div class="flex flex-wrap items-center gap-2 mt-2">
    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium
        {% if motion.status == 'draft' %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400
        {% elif motion.status == 'review' %}bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300
        {% elif motion.status == 'approved' %}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300
        {% elif motion.status == 'submitted' %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300
        {% elif motion.status == 'completed' %}bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300
        {% elif motion.status == 'rejected' %}bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300
        {% else %}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
        {{ motion.get_status_display }}
    </span>
    <!-- Visibility Badge -->
    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs {{ motion.get_visibility_badge_class }}">
        <i data-lucide="{{ motion.get_visibility_icon }}" class="w-3 h-3"></i>
        {{ motion.get_visibility_display }}
    </span>
    <span class="text-sm text-gray-500 dark:text-gray-400">{{ motion.get_type_display }}</span>
    <span class="text-gray-300 dark:text-gray-600">·</span>
    <span class="text-sm text-gray-500 dark:text-gray-400">von {{ motion.author.user.get_display_name }}</span>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    <!-- Share Button -->
    <button type="button"
            @click="showShareModal = true"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
        <i data-lucide="share-2" class="w-4 h-4"></i>
        Teilen
    </button>
    {% if can_edit %}
    <a href="{% url 'work:motion_edit' org_slug=organization.slug motion_id=motion.id %}"
       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
        <i data-lucide="edit-2" class="w-4 h-4"></i>
        Bearbeiten
    </a>
    {% endif %}
    <div class="relative" x-data="{ open: false }">
        <button @click="open = !open" @click.away="open = false"
                class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <i data-lucide="more-vertical" class="w-5 h-5"></i>
        </button>
        <div x-show="open" x-transition
             class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-10">
            <a href="{% url 'work:motion_export' org_slug=organization.slug motion_id=motion.id %}?format=pdf"
               class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i data-lucide="download" class="w-4 h-4"></i>
                Als PDF exportieren
            </a>
            <a href="{% url 'work:motion_share' org_slug=organization.slug motion_id=motion.id %}"
               class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i data-lucide="settings" class="w-4 h-4"></i>
                Erweiterte Freigaben
            </a>
            <hr class="my-1 border-gray-200 dark:border-gray-700">
            <a href="{% url 'work:motions' org_slug=organization.slug %}"
               class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Zurück zur Liste
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block work_content %}
<div x-data="documentViewer()" class="flex gap-6 h-[calc(100vh-220px)] min-h-[500px]">
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-w-0">
        <!-- Summary -->
        {% if motion.summary %}
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 mb-4">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Zusammenfassung</h3>
            <p class="text-gray-900 dark:text-white">{{ motion.summary }}</p>
        </div>
        {% endif %}

        <!-- Document Content -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">
            <!-- Content Header -->
            <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-sm font-medium text-gray-900 dark:text-white">Inhalt</h3>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500" x-show="selectedText">
                        <i data-lucide="text-select" class="w-3 h-3 inline-block mr-1"></i>
                        Text markiert
                    </span>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6"
                 @mouseup="handleTextSelection($event)"
                 id="document-content">
                <div class="prose prose-gray dark:prose-invert max-w-none motion-content">
                    {{ motion.content|safe|default:"<p class='text-gray-500 italic'>Kein Inhalt vorhanden.</p>" }}
                </div>
            </div>

            <!-- Documents/Attachments -->
            {% if documents %}
            <div class="border-t border-gray-200 dark:border-gray-700 p-4">
                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Anhänge</h4>
                <div class="flex flex-wrap gap-2">
                    {% for doc in documents %}
                    <a href="{{ doc.file.url }}" target="_blank"
                       class="inline-flex items-center gap-2 px-3 py-2 text-sm bg-gray-50 dark:bg-gray-900 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-750 border border-gray-200 dark:border-gray-700">
                        <i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ doc.filename }}</span>
                        <span class="text-xs text-gray-500">({{ doc.file_size|filesizeformat }})</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Meta Info & Status (collapsible on smaller screens) -->
        <div class="mt-4 grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                <dt class="text-xs text-gray-500 dark:text-gray-400 mb-1">Erstellt</dt>
                <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ motion.created_at|date:"d.m.Y" }}</dd>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                <dt class="text-xs text-gray-500 dark:text-gray-400 mb-1">Zuletzt bearbeitet</dt>
                <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ motion.updated_at|date:"d.m.Y H:i" }}</dd>
            </div>
            {% if motion.template %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                <dt class="text-xs text-gray-500 dark:text-gray-400 mb-1">Vorlage</dt>
                <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ motion.template.name }}</dd>
            </div>
            {% endif %}
            {% if revisions %}
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                <dt class="text-xs text-gray-500 dark:text-gray-400 mb-1">Versionen</dt>
                <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ revisions.count }} Revision{% if revisions.count != 1 %}en{% endif %}</dd>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Comments Sidebar -->
    <div class="w-80 flex-shrink-0 hidden lg:block">
        {% include "work/motions/partials/_comments_sidebar.html" %}
    </div>

    <!-- Floating Comment Popup (appears when text is selected) -->
    <div x-show="showCommentPopup"
         x-transition:enter="transition ease-out duration-150"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         :style="`position: fixed; top: ${popupPosition.top}px; left: ${popupPosition.left}px;`"
         class="z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-4 w-80"
         @click.away="closeCommentPopup()">

        <!-- Selected Text Preview -->
        <div class="mb-3 p-2 bg-amber-50 dark:bg-amber-900/20 rounded-lg border-l-2 border-amber-400">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Markierter Text:</p>
            <p class="text-sm text-gray-700 dark:text-gray-300 italic" x-text="selectedText.substring(0, 80) + (selectedText.length > 80 ? '...' : '')"></p>
        </div>

        <!-- Comment Form -->
        <form method="post"
              action="{% url 'work:motion_comment' org_slug=organization.slug motion_id=motion.id %}"
              @submit="closeCommentPopup()">
            {% csrf_token %}
            <input type="hidden" name="selection_start" :value="selectionStart">
            <input type="hidden" name="selection_end" :value="selectionEnd">
            <input type="hidden" name="selected_text" :value="selectedText">

            <textarea name="content"
                      rows="3"
                      x-ref="popupTextarea"
                      required
                      placeholder="Kommentar hinzufügen..."
                      class="w-full px-3 py-2 text-sm bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"></textarea>

            <div class="flex justify-end gap-2 mt-3">
                <button type="button"
                        @click="closeCommentPopup()"
                        class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    Abbrechen
                </button>
                <button type="submit"
                        class="px-3 py-1.5 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                    Kommentieren
                </button>
            </div>
        </form>
    </div>

    <!-- Share Modal -->
    {% with shareMotionId=motion.id shareMotionTitle=motion.title shareVisibility=motion.visibility %}
    <div x-show="showShareModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
         @click.self="showShareModal = false"
         @keydown.escape.window="showShareModal = false">
        <div x-show="showShareModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md overflow-hidden">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Dokument teilen</h3>
                    <button @click="showShareModal = false"
                            class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">{{ motion.title }}</p>
            </div>

            <!-- Body -->
            <form action="{% url 'work:motion_share_update' org_slug=organization.slug motion_id=motion.id %}"
                  method="post"
                  hx-post="{% url 'work:motion_share_update' org_slug=organization.slug motion_id=motion.id %}"
                  hx-swap="none">
                {% csrf_token %}
                <div class="p-6 space-y-4">
                    <div class="space-y-3">
                        <!-- Private -->
                        <label class="flex items-start gap-3 p-3 rounded-xl border cursor-pointer transition-all"
                               :class="shareVisibility === 'private' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750'">
                            <input type="radio" name="visibility" value="private" x-model="shareVisibility" class="mt-0.5 text-primary-600">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="lock" class="w-4 h-4 text-gray-500"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">Privat</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-0.5">Nur Sie können dieses Dokument sehen</p>
                            </div>
                        </label>
                        <!-- Shared -->
                        <label class="flex items-start gap-3 p-3 rounded-xl border cursor-pointer transition-all"
                               :class="shareVisibility === 'shared' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750'">
                            <input type="radio" name="visibility" value="shared" x-model="shareVisibility" class="mt-0.5 text-primary-600">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="users" class="w-4 h-4 text-gray-500"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">Mit bestimmten Personen</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-0.5">Teilen Sie mit ausgewählten Mitgliedern</p>
                            </div>
                        </label>
                        <!-- Organization -->
                        <label class="flex items-start gap-3 p-3 rounded-xl border cursor-pointer transition-all"
                               :class="shareVisibility === 'organization' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750'">
                            <input type="radio" name="visibility" value="organization" x-model="shareVisibility" class="mt-0.5 text-primary-600">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="building" class="w-4 h-4 text-gray-500"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">Gesamte Organisation</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-0.5">Alle Mitglieder von {{ organization.name }}</p>
                            </div>
                        </label>
                    </div>

                    <!-- Add user for shared -->
                    <div x-show="shareVisibility === 'shared'" x-transition class="pt-4 border-t border-gray-200 dark:border-gray-700">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Person hinzufügen</label>
                        <input type="email" name="add_user_email" placeholder="E-Mail-Adresse..." class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 flex justify-end gap-2">
                    <button type="button" @click="showShareModal = false" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Abbrechen</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">Speichern</button>
                </div>
            </form>
        </div>
    </div>
    {% endwith %}
</div>

<style>
/* Reset styles for content copied from external sources */
.motion-content * {
    all: revert;
}
.motion-content {
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 1rem;
    line-height: 1.75;
    color: #374151;
}
.dark .motion-content {
    color: #d1d5db;
}
.motion-content h1 { font-size: 1.875rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #111827; }
.dark .motion-content h1 { color: #f9fafb; }
.motion-content h2 { font-size: 1.5rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #111827; }
.dark .motion-content h2 { color: #f9fafb; }
.motion-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #111827; }
.dark .motion-content h3 { color: #f9fafb; }
.motion-content p { margin-top: 0.75rem; margin-bottom: 0.75rem; }
.motion-content ul, .motion-content ol { padding-left: 1.5rem; margin-top: 0.75rem; margin-bottom: 0.75rem; }
.motion-content ul { list-style-type: disc; }
.motion-content ol { list-style-type: decimal; }
.motion-content li { margin-top: 0.25rem; margin-bottom: 0.25rem; }
.motion-content strong { font-weight: 600; color: #111827; }
.dark .motion-content strong { color: #f9fafb; }
.motion-content blockquote { border-left: 4px solid #6366f1; padding-left: 1rem; margin: 1rem 0; color: #4b5563; font-style: italic; }
.dark .motion-content blockquote { color: #9ca3af; border-color: #818cf8; }
.motion-content a { color: #4f46e5; text-decoration: underline; }
.dark .motion-content a { color: #818cf8; }

/* Comment highlight markers */
.comment-highlight {
    background-color: rgba(251, 191, 36, 0.3);
    cursor: pointer;
    border-radius: 2px;
}
.comment-highlight:hover {
    background-color: rgba(251, 191, 36, 0.5);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function documentViewer() {
    return {
        // Comment popup state
        showCommentPopup: false,
        popupPosition: { top: 0, left: 0 },
        selectedText: '',
        selectionStart: null,
        selectionEnd: null,

        // Sidebar state
        showResolvedComments: false,
        replyingToComment: null,
        newCommentContent: '',

        // Share modal state
        showShareModal: false,
        shareVisibility: '{{ motion.visibility }}',

        handleTextSelection(event) {
            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text.length > 3) {
                this.selectedText = text;

                // Get selection range
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();

                // Position popup below the selection
                this.popupPosition = {
                    top: Math.min(rect.bottom + window.scrollY + 10, window.innerHeight - 250),
                    left: Math.max(10, Math.min(rect.left + window.scrollX, window.innerWidth - 340))
                };

                this.showCommentPopup = true;

                // Focus textarea after a short delay
                this.$nextTick(() => {
                    if (this.$refs.popupTextarea) {
                        this.$refs.popupTextarea.focus();
                    }
                });
            }
        },

        closeCommentPopup() {
            this.showCommentPopup = false;
            // Don't clear selectedText immediately to allow form submission
        },

        clearSelection() {
            this.selectedText = '';
            this.selectionStart = null;
            this.selectionEnd = null;
            window.getSelection().removeAllRanges();
        },

        replyToComment(commentId) {
            this.replyingToComment = commentId;
        },

        scrollToCommentInContent(commentId) {
            // If the comment has a highlight marker, scroll to it
            const marker = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (marker) {
                marker.scrollIntoView({ behavior: 'smooth', block: 'center' });
                marker.classList.add('ring-2', 'ring-primary-500');
                setTimeout(() => {
                    marker.classList.remove('ring-2', 'ring-primary-500');
                }, 2000);
            }
        }
    }
}
</script>
{% endblock %}
