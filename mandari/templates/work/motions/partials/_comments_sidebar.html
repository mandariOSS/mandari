<!-- Comments Sidebar (Google Docs Style) -->
<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 h-full flex flex-col">
    <!-- Header -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h3 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
            <i data-lucide="message-square" class="w-4 h-4"></i>
            Kommentare
            <span class="text-sm font-normal text-gray-500">({{ comments.count }})</span>
        </h3>
        <button type="button"
                @click="showResolvedComments = !showResolvedComments"
                class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
            <span x-text="showResolvedComments ? 'Erledigte ausblenden' : 'Erledigte anzeigen'"></span>
        </button>
    </div>

    <!-- Comment List -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4">
        {% for comment in comments %}
        <div class="group relative"
             :class="{ 'opacity-50': {{ comment.is_resolved|yesno:'true,false' }} && !showResolvedComments }"
             x-show="!{{ comment.is_resolved|yesno:'true,false' }} || showResolvedComments"
             id="comment-sidebar-{{ comment.id }}"
             @click="scrollToCommentInContent('{{ comment.id }}')">

            <!-- Comment Card -->
            <div class="p-3 rounded-xl border transition-all cursor-pointer
                        {% if comment.is_resolved %}
                        bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800
                        {% else %}
                        bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-700
                        {% endif %}">

                <!-- Author & Time -->
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                        <span class="text-xs font-medium text-primary-600 dark:text-primary-400">
                            {{ comment.author.user.get_initials }}
                        </span>
                    </div>
                    <span class="text-xs font-medium text-gray-900 dark:text-white">
                        {{ comment.author.user.get_display_name }}
                    </span>
                    <span class="text-xs text-gray-500">·</span>
                    <span class="text-xs text-gray-500">{{ comment.created_at|timesince }}</span>
                    {% if comment.is_resolved %}
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                        <i data-lucide="check" class="w-3 h-3"></i>
                        Erledigt
                    </span>
                    {% endif %}
                </div>

                <!-- Selected Text (if inline comment) -->
                {% if comment.selected_text %}
                <div class="mb-2 px-2 py-1.5 bg-amber-50 dark:bg-amber-900/20 border-l-2 border-amber-400 text-xs text-gray-600 dark:text-gray-400 italic rounded-r">
                    "{{ comment.selected_text|truncatewords:15 }}"
                </div>
                {% endif %}

                <!-- Comment Content -->
                <p class="text-sm text-gray-700 dark:text-gray-300">{{ comment.content }}</p>

                <!-- Actions -->
                <div class="flex items-center gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    {% if not comment.is_resolved %}
                    <button type="button"
                            @click.stop="replyToComment('{{ comment.id }}')"
                            class="text-xs text-gray-500 hover:text-primary-600 flex items-center gap-1">
                        <i data-lucide="reply" class="w-3 h-3"></i>
                        Antworten
                    </button>
                    {% endif %}
                    {% if not comment.is_resolved and comment.author == membership or membership.has_permission %}
                    <form method="post"
                          action="{% url 'work:motion_comment_resolve' org_slug=organization.slug motion_id=motion.id comment_id=comment.id %}"
                          @click.stop
                          class="inline">
                        {% csrf_token %}
                        <button type="submit"
                                class="text-xs text-gray-500 hover:text-green-600 flex items-center gap-1">
                            <i data-lucide="check-circle" class="w-3 h-3"></i>
                            Erledigen
                        </button>
                    </form>
                    {% endif %}
                </div>

                <!-- Replies -->
                {% if comment.replies.all %}
                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 space-y-3">
                    {% for reply in comment.replies.all %}
                    <div class="flex gap-2">
                        <div class="w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center flex-shrink-0">
                            <span class="text-[10px] font-medium text-gray-600 dark:text-gray-400">
                                {{ reply.author.user.get_initials }}
                            </span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-medium text-gray-900 dark:text-white">
                                    {{ reply.author.user.get_display_name }}
                                </span>
                                <span class="text-xs text-gray-500">{{ reply.created_at|timesince }}</span>
                            </div>
                            <p class="text-xs text-gray-700 dark:text-gray-300 mt-0.5">{{ reply.content }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Reply Form (shown when replying) -->
                <div x-show="replyingToComment === '{{ comment.id }}'"
                     x-transition
                     @click.stop
                     class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <form method="post"
                          action="{% url 'work:motion_comment' org_slug=organization.slug motion_id=motion.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="parent" value="{{ comment.id }}">
                        <textarea name="content"
                                  rows="2"
                                  required
                                  placeholder="Antwort schreiben..."
                                  class="w-full px-3 py-2 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"></textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button type="button"
                                    @click="replyingToComment = null"
                                    class="px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                Abbrechen
                            </button>
                            <button type="submit"
                                    class="px-3 py-1.5 text-xs font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                                Antworten
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8">
            <div class="w-12 h-12 mx-auto mb-3 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                <i data-lucide="message-square" class="w-6 h-6 text-gray-400"></i>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Noch keine Kommentare</p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                Markieren Sie Text, um einen Kommentar hinzuzufügen
            </p>
        </div>
        {% endfor %}
    </div>

    <!-- New Comment Form -->
    <div class="border-t border-gray-200 dark:border-gray-700 p-4">
        <form method="post"
              action="{% url 'work:motion_comment' org_slug=organization.slug motion_id=motion.id %}"
              class="space-y-3">
            {% csrf_token %}
            <input type="hidden" name="selection_start" :value="selectionStart">
            <input type="hidden" name="selection_end" :value="selectionEnd">
            <input type="hidden" name="selected_text" :value="selectedText">

            <!-- Show selected text if any -->
            <div x-show="selectedText" class="p-2 bg-amber-50 dark:bg-amber-900/20 border-l-2 border-amber-400 rounded-r">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Kommentar zu:</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 italic" x-text="selectedText.substring(0, 100) + (selectedText.length > 100 ? '...' : '')"></p>
            </div>

            <textarea name="content"
                      rows="3"
                      x-model="newCommentContent"
                      required
                      placeholder="Kommentar hinzufügen..."
                      class="w-full px-3 py-2.5 text-sm bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"></textarea>
            <div class="flex items-center justify-between">
                <button type="button"
                        x-show="selectedText"
                        @click="clearSelection()"
                        class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    Markierung aufheben
                </button>
                <button type="submit"
                        :disabled="!newCommentContent.trim()"
                        class="ml-auto inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="send" class="w-4 h-4"></i>
                    Senden
                </button>
            </div>
        </form>
    </div>
</div>
