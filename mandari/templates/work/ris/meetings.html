{% extends "work/base_work.html" %}

{% block page_title %}Sitzungen{% endblock %}

{% block header_title %}Sitzungen{% endblock %}
{% block header_subtitle %}
{% if body %}
<p class="work-page-subtitle">{{ body.get_display_name }}</p>
{% endif %}
{% endblock %}

{% block header_actions %}
<a href="{% url 'work:ris_overview' org_slug=organization.slug %}"
   class="inline-flex items-center gap-2 px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
    <i data-lucide="arrow-left" class="w-4 h-4"></i>
    Zurück
</a>
{% endblock %}

{% block work_content %}
{% if no_body_linked %}
<div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-6 text-center">
    <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-amber-500 mb-4"></i>
    <h3 class="text-lg font-semibold text-amber-800 dark:text-amber-200 mb-2">Keine Kommune verknüpft</h3>
    <p class="text-amber-700 dark:text-amber-300">
        Dieser Organisation ist noch keine Kommune zugewiesen.
    </p>
</div>
{% else %}

<!-- View Toggle & Filters -->
<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700/50 p-6 mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <!-- View Toggle -->
        <div class="flex bg-gray-100 dark:bg-gray-700/50 rounded-lg p-1">
            <a href="?view=upcoming{% if selected_org %}&org={{ selected_org }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
               class="px-4 py-2 rounded-md text-sm font-medium transition-colors {% if view_mode == 'upcoming' %}bg-white dark:bg-gray-600 shadow-sm text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %}">
                Kommende
            </a>
            <a href="?view=past{% if selected_org %}&org={{ selected_org }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
               class="px-4 py-2 rounded-md text-sm font-medium transition-colors {% if view_mode == 'past' %}bg-white dark:bg-gray-600 shadow-sm text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %}">
                Vergangene
            </a>
            <a href="?view=all{% if selected_org %}&org={{ selected_org }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
               class="px-4 py-2 rounded-md text-sm font-medium transition-colors {% if view_mode == 'all' %}bg-white dark:bg-gray-600 shadow-sm text-gray-900 dark:text-white{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %}">
                Alle
            </a>
        </div>

        <div class="flex-1"></div>

        <!-- Organization Filter -->
        <form method="get" class="flex items-center gap-3">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <select name="org" onchange="this.form.submit()"
                    class="px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 text-gray-900 dark:text-white">
                <option value="">Alle Gremien</option>
                {% for org in organizations %}
                <option value="{{ org.id }}" {% if selected_org == org.id|slugify %}selected{% endif %}>{{ org.short_name|default:org.name }}</option>
                {% endfor %}
            </select>

            <select name="year" onchange="this.form.submit()"
                    class="px-4 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 text-gray-900 dark:text-white">
                <option value="">Alle Jahre</option>
                {% for year in years %}
                <option value="{{ year.year }}" {% if selected_year == year.year %}selected{% endif %}>{{ year.year }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Meetings List -->
<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700/50 overflow-hidden">
    <div class="divide-y divide-gray-100/80 dark:divide-gray-700/30">
        {% for meeting in meetings %}
        <a href="{% url 'work:ris_meeting_detail' org_slug=organization.slug meeting_id=meeting.id %}"
           class="block px-6 py-5 hover:bg-gray-50/50 dark:hover:bg-gray-750/50 transition-colors">
            <div class="flex items-start gap-4">
                <!-- Date -->
                <div class="flex-shrink-0 w-14 py-2 text-center rounded-lg {% if meeting.cancelled %}bg-gray-50 dark:bg-gray-700/50{% else %}bg-primary-50/70 dark:bg-primary-900/20{% endif %}">
                    <div class="text-xl font-bold {% if meeting.cancelled %}text-gray-400 line-through{% else %}text-primary-600 dark:text-primary-400{% endif %}">
                        {{ meeting.start|date:"d" }}
                    </div>
                    <div class="text-xs {% if meeting.cancelled %}text-gray-400{% else %}text-primary-500 dark:text-primary-400{% endif %} uppercase">{{ meeting.start|date:"M Y" }}</div>
                </div>

                <div class="flex-1 min-w-0 py-1">
                    <div class="flex items-center gap-2">
                        <p class="font-medium text-gray-900 dark:text-white {% if meeting.cancelled %}line-through text-gray-500{% endif %}">
                            {{ meeting.get_display_name }}
                        </p>
                        {% if meeting.cancelled %}
                        <span class="px-2 py-0.5 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded text-xs">Abgesagt</span>
                        {% endif %}
                    </div>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-gray-500 dark:text-gray-400">
                        <span>{{ meeting.start|date:"H:i" }} Uhr</span>
                        {% if meeting.location_name %}
                        <span>{{ meeting.location_name|truncatechars:30 }}</span>
                        {% endif %}
                    </div>
                    {% with orgs=meeting.get_organization_names %}
                    {% if orgs %}
                    <div class="flex flex-wrap gap-1.5 mt-3">
                        {% for org in orgs %}
                        <span class="px-2 py-0.5 bg-purple-50/70 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 rounded text-xs">{{ org }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>

                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 dark:text-gray-600 flex-shrink-0 mt-2"></i>
            </div>
        </a>
        {% empty %}
        <div class="px-5 py-12 text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                <i data-lucide="calendar-x" class="w-8 h-8 text-green-500 dark:text-green-400"></i>
            </div>
            <p class="text-lg font-medium text-gray-900 dark:text-white mb-1">Keine Sitzungen gefunden</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">
                {% if view_mode == 'upcoming' %}
                Es sind keine kommenden Sitzungen geplant.
                {% else %}
                Versuche andere Filter.
                {% endif %}
            </p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if meetings.has_other_pages %}
    <div class="px-6 py-4 border-t border-gray-100/80 dark:border-gray-700/30">
        <div class="flex items-center justify-between">
            <p class="text-sm text-gray-500 dark:text-gray-400">
                Zeige {{ meetings.start_index }}-{{ meetings.end_index }} von {{ paginator.count }}
            </p>
            <nav class="flex items-center gap-1">
                {% if meetings.has_previous %}
                <a href="?page={{ meetings.previous_page_number }}&view={{ view_mode }}{% if selected_org %}&org={{ selected_org }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
                   class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </a>
                {% endif %}

                {% for num in meetings.paginator.page_range %}
                {% if meetings.number == num %}
                <span class="px-3 py-2 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-lg font-medium text-sm">{{ num }}</span>
                {% elif num > meetings.number|add:'-3' and num < meetings.number|add:'3' %}
                <a href="?page={{ num }}&view={{ view_mode }}{% if selected_org %}&org={{ selected_org }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
                   class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-300">{{ num }}</a>
                {% endif %}
                {% endfor %}

                {% if meetings.has_next %}
                <a href="?page={{ meetings.next_page_number }}&view={{ view_mode }}{% if selected_org %}&org={{ selected_org }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}"
                   class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </a>
                {% endif %}
            </nav>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}
