{% extends "work/base_work.html" %}
{% load static %}

{% block page_title %}Karte{% endblock %}

{% block header_title %}Karte{% endblock %}
{% block header_subtitle %}
{% if body %}
<p class="work-page-subtitle">{{ body.get_display_name }} · Geolokalisierte Vorgänge</p>
{% endif %}
{% endblock %}

{% block header_actions %}
<a href="{% url 'work:ris_overview' org_slug=organization.slug %}"
   class="inline-flex items-center gap-2 px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
    <i data-lucide="arrow-left" class="w-4 h-4"></i>
    Zurück
</a>
{% endblock %}

{% block work_extra_head %}
<link rel="stylesheet" href="{% static 'vendor/leaflet/leaflet.css' %}" />
<script src="{% static 'vendor/leaflet/leaflet.min.js' %}"></script>
<style>
    #map {
        height: calc(100vh - 260px);
        min-height: 400px;
        border-radius: 12px;
    }
    .leaflet-popup-content {
        font-family: inherit;
    }
    .dark .leaflet-tile-pane {
        filter: invert(1) hue-rotate(180deg) brightness(0.9);
    }
</style>
{% endblock %}

{% block work_content %}
{% if no_body_linked %}
<div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-6 text-center">
    <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-amber-500 mb-4"></i>
    <h3 class="text-lg font-semibold text-amber-800 dark:text-amber-200 mb-2">Keine Kommune verknüpft</h3>
</div>
{% else %}

<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div id="map"></div>
</div>

<div class="mt-4 text-sm text-gray-500 text-center">
    Klicken Sie auf einen Marker, um Details zum Vorgang anzuzeigen.
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mapConfig = {{ map_config|safe }};

    // Initialize map
    const map = L.map('map').setView([mapConfig.center_lat, mapConfig.center_lng], mapConfig.zoom);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Fit bounds if available
    if (mapConfig.bbox && mapConfig.bbox.north) {
        map.fitBounds([
            [mapConfig.bbox.south, mapConfig.bbox.west],
            [mapConfig.bbox.north, mapConfig.bbox.east]
        ]);
    }

    // Load GeoJSON data
    fetch('{% url "work:ris_map_data" org_slug=organization.slug %}')
        .then(response => response.json())
        .then(data => {
            if (data.features.length === 0) {
                document.getElementById('map').innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center p-8">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                            </svg>
                            <p class="text-lg font-medium">Keine Standorte gefunden</p>
                            <p class="text-sm">Es gibt noch keine geolokalisierte Vorgänge.</p>
                        </div>
                    </div>
                `;
                return;
            }

            L.geoJSON(data, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: '#4f46e5',
                        color: '#312e81',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.7
                    });
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const popupContent = `
                        <div class="p-2">
                            <h3 class="font-semibold text-gray-900 mb-1">${props.title}</h3>
                            ${props.reference ? `<p class="text-xs text-gray-500 mb-1">${props.reference}</p>` : ''}
                            ${props.location_name ? `<p class="text-sm text-gray-600 mb-2">${props.location_name}</p>` : ''}
                            ${props.date ? `<p class="text-xs text-gray-400">${new Date(props.date).toLocaleDateString('de-DE')}</p>` : ''}
                            <a href="{% url 'work:ris_paper_detail' org_slug=organization.slug paper_id='PLACEHOLDER' %}".replace('PLACEHOLDER', props.id)
                               class="inline-block mt-2 text-sm text-primary-600 hover:underline">
                                Details anzeigen &rarr;
                            </a>
                        </div>
                    `;
                    layer.bindPopup(popupContent);
                }
            }).addTo(map);

            // Fit to markers if we have data
            if (data.features.length > 0) {
                const bounds = L.geoJSON(data).getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        })
        .catch(error => {
            console.error('Failed to load map data:', error);
        });
});
</script>

{% endif %}
{% endblock %}
