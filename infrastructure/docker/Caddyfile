# =============================================================================
# Mandari 2.0 - Caddy Configuration (E2E Encryption)
# =============================================================================
# TLS is handled by Caddy with automatic Let's Encrypt certificates.
# The Load Balancer uses TCP passthrough (no TLS termination).
#
# Using DNS-01 challenge via Hetzner DNS API:
# - Works behind Load Balancers with multiple backend servers
# - No need for HTTP-01/TLS-ALPN-01 challenges
# - Requires HETZNER_DNS_API_TOKEN environment variable
# =============================================================================

{
    # Let's Encrypt email for certificate notifications
    email admin@mandari.de

    # Use DNS-01 challenge via Hetzner DNS
    acme_dns hetzner {$HETZNER_DNS_API_TOKEN}

    # Logging
    log {
        level INFO
        format json
    }
}

# =============================================================================
# Localhost Health Check (for Docker/internal monitoring on HTTP)
# =============================================================================
http://localhost {
    handle /health {
        respond "OK" 200
    }
    handle /health/ {
        respond "OK" 200
    }
    handle {
        respond "Not Found" 404
    }
}

# =============================================================================
# Organization Subdomains (e.g., volt.mandari.de)
# =============================================================================
# Wildcard subdomain support - proxies to Django which handles the redirect
# DNS-01 challenge allows wildcard certificates
*.{$DOMAIN:mandari.de} {
    # Compression
    encode gzip zstd

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        -Server
    }

    # Proxy everything to Django - middleware handles redirect
    reverse_proxy mandari-web:8000 {
        header_up X-Real-IP {remote_host}
        header_up Host {host}
        header_up X-Forwarded-Host {host}
    }

    # Logging
    log {
        output file /data/subdomain-access.log {
            roll_size 10mb
            roll_keep 3
        }
    }
}

# =============================================================================
# Main Site - HTTPS with automatic TLS
# =============================================================================
{$DOMAIN:mandari.de} {
    # Compression
    encode gzip zstd

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        -Server

        # Cache control for static assets
        Cache-Control "public, max-age=31536000" {
            path /static/*
            path /_app/*
            path /assets/*
        }
    }

    # Health check endpoint (responds on both HTTP and HTTPS)
    handle /health {
        respond "OK" 200
    }

    handle /health/ {
        respond "OK" 200
    }

    # API routes
    handle /api/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}

            transport http {
                dial_timeout 10s
                response_header_timeout 120s
            }
        }
    }

    # Admin routes
    handle /admin/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # Accounts routes (authentication)
    handle /accounts/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # Work Portal
    handle /work/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # Session RIS
    handle /session/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # Static files (Django)
    handle /static/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # Media files (uploaded content)
    handle /media/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # WebSocket support
    handle /ws/* {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
            header_up Connection {header.Connection}
            header_up Upgrade {header.Upgrade}
        }
    }

    # Public Portal (default - catch all)
    handle {
        reverse_proxy mandari-web:8000 {
            header_up X-Real-IP {remote_host}
            header_up Host {host}
        }
    }

    # Logging
    log {
        output file /data/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}
