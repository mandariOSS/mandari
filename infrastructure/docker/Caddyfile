# =============================================================================
# Mandari 2.0 - Caddy Configuration (E2E Encryption)
# =============================================================================
# TLS is handled by Caddy with automatic Let's Encrypt certificates.
# The Load Balancer uses TCP passthrough (no TLS termination).
# =============================================================================

{
    # Let's Encrypt email for certificate notifications
    email admin@mandari.de

    # Logging
    log {
        level INFO
        format json
    }
}

# =============================================================================
# HTTPS - Main Site (Caddy handles TLS via Let's Encrypt)
# =============================================================================
{$DOMAIN:mandari.de} {
    # Compression
    encode gzip zstd

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        -Server

        # Cache control for static assets
        Cache-Control "public, max-age=31536000" {
            path /static/*
            path /_app/*
            path /assets/*
        }
    }

    # Health check endpoint (for Load Balancer - responds on HTTPS)
    handle /health {
        respond "OK" 200
    }

    handle /health/ {
        respond "OK" 200
    }

    # API routes
    handle /api/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}

            transport http {
                dial_timeout 10s
                response_header_timeout 120s
            }
        }
    }

    # Admin routes
    handle /admin/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Accounts routes (authentication)
    handle /accounts/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Work Portal
    handle /work/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Session RIS
    handle /session/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Static files (Django)
    handle /static/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Media files (uploaded content)
    handle /media/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # WebSocket support
    handle /ws/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
            header_up Connection {header.Connection}
            header_up Upgrade {header.Upgrade}
        }
    }

    # Public Portal (default - catch all)
    handle {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Logging
    log {
        output file /data/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

# =============================================================================
# HTTP -> HTTPS Redirect (with health check for internal monitoring)
# =============================================================================
:80 {
    # Health check endpoint for internal/LB monitoring
    handle /health {
        respond "OK" 200
    }
    handle /health/ {
        respond "OK" 200
    }

    # Redirect everything else to HTTPS
    handle {
        redir https://{host}{uri} permanent
    }
}
