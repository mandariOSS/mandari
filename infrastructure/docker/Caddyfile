# =============================================================================
# Mandari 2.0 - Caddy Configuration (E2E Encryption)
# =============================================================================
# This Caddyfile configures Caddy with TLS termination at the backend.
# The Hetzner Load Balancer operates in TCP passthrough mode.
# =============================================================================

{
    # Let's Encrypt email for certificate notifications
    email admin@mandari.de

    # Accept ProxyProtocol from Hetzner Load Balancer
    servers {
        listener_wrappers {
            proxy_protocol {
                timeout 5s
                allow 10.0.0.0/16
            }
            tls
        }
    }

    # Logging
    log {
        level INFO
        format json
    }
}

# =============================================================================
# HTTPS - Main Site (Caddy handles TLS)
# =============================================================================
{$DOMAIN:mandari.de} {
    # Compression
    encode gzip zstd

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        -Server

        # Cache control for static assets
        Cache-Control "public, max-age=31536000" {
            path /static/*
            path /_app/*
            path /assets/*
        }
    }

    # Health check endpoint (for Load Balancer)
    handle /health {
        respond "OK" 200
    }

    handle /health/ {
        respond "OK" 200
    }

    # API routes
    handle /api/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            transport http {
                dial_timeout 10s
                response_header_timeout 120s
            }
        }
    }

    # Admin routes
    handle /admin/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Accounts routes (authentication)
    handle /accounts/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Work Portal
    handle /work/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Session RIS
    handle /session/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Static files (Django)
    handle /static/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Media files (uploaded content)
    handle /media/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket support
    handle /ws/* {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Public Portal (default - catch all)
    handle {
        reverse_proxy api:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Logging
    log {
        output file /data/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

# =============================================================================
# HTTP -> HTTPS Redirect
# =============================================================================
:80 {
    redir https://{$DOMAIN:mandari.de}{uri} permanent
}
