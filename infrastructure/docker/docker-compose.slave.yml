# =============================================================================
# Mandari 2.0 - Docker Compose (Slave/Replica)
# =============================================================================
# This configuration runs on the slave server with:
# - PostgreSQL as REPLICA (read-only, streams from master)
# - Redis as REPLICA (syncs from master)
# - NO Ingestor service (only runs on master)
# =============================================================================

name: mandari

services:
  # ===========================================================================
  # Reverse Proxy
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    container_name: mandari-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - mandari-network
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Database (REPLICA)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: mandari-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mandari}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-mandari}
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
    volumes:
      - ${DATA_DIR:-/mnt/data}/postgres:/var/lib/postgresql/data
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    networks:
      - mandari-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mandari} -d ${POSTGRES_DB:-mandari}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================================================
  # Connection Pooler
  # ===========================================================================
  pgbouncer:
    image: edoburu/pgbouncer:1.21.0-p0
    container_name: mandari-pgbouncer
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-mandari}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-mandari}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 50
      MIN_POOL_SIZE: 10
      RESERVE_POOL_SIZE: 10
      SERVER_RESET_QUERY: DISCARD ALL
      AUTH_TYPE: scram-sha-256
    networks:
      - mandari-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "6432"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Cache (REPLICA)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: mandari-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory ${REDIS_MAXMEMORY:-512mb}
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --replicaof ${MASTER_PRIVATE_IP:-10.0.1.10} 6379
    volumes:
      - ${DATA_DIR:-/mnt/data}/redis:/data
    networks:
      - mandari-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Search Engine
  # ===========================================================================
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: mandari-meilisearch
    restart: unless-stopped
    environment:
      MEILI_ENV: production
      MEILI_MASTER_KEY: ${MEILISEARCH_KEY}
      MEILI_NO_ANALYTICS: "true"
      MEILI_HTTP_PAYLOAD_SIZE_LIMIT: 104857600
    volumes:
      - ${DATA_DIR:-/mnt/data}/meilisearch:/meili_data
    networks:
      - mandari-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7700/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ===========================================================================
  # API Backend
  # ===========================================================================
  api:
    image: ${DOCKER_REGISTRY:-ghcr.io/mandarioss/mandari}-api:${IMAGE_TAG:-latest}
    container_name: mandari-api
    restart: unless-stopped
    environment:
      # Database - connects to local replica for reads
      # NOTE: Writes will still go through, but they'll be forwarded to primary
      # For strict read-only, use a read replica connection string
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-mandari}:${POSTGRES_PASSWORD}@pgbouncer:6432/${POSTGRES_DB:-mandari}
      # For writes, connect to master
      DATABASE_URL_PRIMARY: postgresql+asyncpg://${POSTGRES_USER:-mandari}:${POSTGRES_PASSWORD}@${MASTER_PRIVATE_IP:-10.0.1.10}:5432/${POSTGRES_DB:-mandari}
      # Cache
      REDIS_URL: redis://redis:6379
      # Search
      MEILISEARCH_URL: http://meilisearch:7700
      MEILISEARCH_KEY: ${MEILISEARCH_KEY}
      # App
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: "false"
      ENVIRONMENT: production
      SITE_URL: ${SITE_URL:-https://mandari.de}
      # Encryption
      ENCRYPTION_MASTER_KEY: ${ENCRYPTION_MASTER_KEY}
      # Replica mode flag
      IS_REPLICA: "true"
    networks:
      - mandari-network
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # NO INGESTOR ON SLAVE!
  # ===========================================================================
  # The ingestor service only runs on the master to avoid
  # duplicate ingestion and write conflicts.

  # ===========================================================================
  # Public Frontend
  # ===========================================================================
  web-public:
    image: ${DOCKER_REGISTRY:-ghcr.io/mandarioss/mandari}-web-public:${IMAGE_TAG:-latest}
    container_name: mandari-web-public
    restart: unless-stopped
    environment:
      ORIGIN: ${SITE_URL:-https://mandari.de}
      API_URL: http://api:8000
    networks:
      - mandari-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Work Portal Frontend
  # ===========================================================================
  web-work:
    image: ${DOCKER_REGISTRY:-ghcr.io/mandarioss/mandari}-web-work:${IMAGE_TAG:-latest}
    container_name: mandari-web-work
    restart: unless-stopped
    environment:
      ORIGIN: ${SITE_URL:-https://mandari.de}
      API_URL: http://api:8000
      BASE_PATH: /work
    networks:
      - mandari-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# Volumes
# =============================================================================
volumes:
  caddy_data:
  caddy_config:

# =============================================================================
# Networks
# =============================================================================
networks:
  mandari-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
