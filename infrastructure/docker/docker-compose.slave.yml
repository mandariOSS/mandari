# =============================================================================
# Mandari 2.0 - Docker Compose (Server 2 / Standby)
# =============================================================================
# HIGH AVAILABILITY CONFIGURATION - STANDBY SERVER
#
# Services:
# - mandari-web: Django SaaS Application (connects to PRIMARY database)
# - postgres: PostgreSQL HOT STANDBY (for failover)
# - redis: Redis REPLICA (syncs from master)
# - meilisearch: Search Engine (local)
# - caddy: HTTPS Reverse Proxy
#
# Normal Operation:
# - mandari-web connects to Server 1's PostgreSQL and Redis
# - Local PostgreSQL runs as hot standby (ready for failover)
#
# Failover Mode:
# - Run failover.sh to promote this server to primary
# - PostgreSQL standby becomes primary
# - Redis replica becomes master
# =============================================================================

name: mandari

services:
  # ===========================================================================
  # Reverse Proxy (Caddy with Hetzner DNS plugin)
  # ===========================================================================
  caddy:
    build:
      context: ./caddy
      dockerfile: Dockerfile
    image: mandari-caddy:latest
    container_name: mandari-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      HETZNER_DNS_API_TOKEN: ${HETZNER_DNS_API_TOKEN}
      DOMAIN: ${DOMAIN:-mandari.de}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - mandari-network
    depends_on:
      mandari-web:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # PostgreSQL (HOT STANDBY - for failover)
  # ===========================================================================
  # This database streams from the primary and is ready to be promoted
  # if Server 1 fails. The mandari-web service does NOT use this directly
  # during normal operation.
  postgres:
    image: postgres:16-alpine
    container_name: mandari-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mandari}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-mandari}
      PGUSER: ${POSTGRES_USER:-mandari}
      PGPASSWORD: ${POSTGRES_PASSWORD}
    command:
      - "postgres"
      - "-c"
      - "hot_standby=on"
      - "-c"
      - "hot_standby_feedback=on"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "hba_file=/etc/postgresql/pg_hba.conf"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "primary_conninfo=host=${MASTER_PRIVATE_IP:-10.0.0.3} port=5432 user=${POSTGRES_USER:-mandari} password=${POSTGRES_PASSWORD}"
    volumes:
      - ${DATA_DIR:-/mnt/data}/postgres:/var/lib/postgresql/data
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    networks:
      - mandari-network
    ports:
      - "5432:5432"
    extra_hosts:
      - "primary-db:${MASTER_PRIVATE_IP:-10.0.0.3}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mandari} -d ${POSTGRES_DB:-mandari}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # Redis (REPLICA - syncs from master)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: mandari-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory ${REDIS_MAXMEMORY:-512mb}
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --replicaof ${MASTER_PRIVATE_IP:-10.0.0.3} 6379
      --replica-read-only yes
    volumes:
      - ${DATA_DIR:-/mnt/data}/redis:/data
    networks:
      - mandari-network
    ports:
      - "6379:6379"
    extra_hosts:
      - "primary-redis:${MASTER_PRIVATE_IP:-10.0.0.3}"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Meilisearch (Search Engine - local)
  # ===========================================================================
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: mandari-meilisearch
    restart: unless-stopped
    environment:
      MEILI_ENV: production
      MEILI_MASTER_KEY: ${MEILISEARCH_KEY}
      MEILI_NO_ANALYTICS: "true"
      MEILI_HTTP_PAYLOAD_SIZE_LIMIT: 104857600
    volumes:
      - ${DATA_DIR:-/mnt/data}/meilisearch:/meili_data
    networks:
      - mandari-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:7700/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ===========================================================================
  # Mandari Web Application (Django SaaS)
  # ===========================================================================
  # Connects to PRIMARY server's PostgreSQL and Redis for all operations.
  # This ensures data consistency across both servers.
  mandari-web:
    image: ghcr.io/mandarioss/mandari:${IMAGE_TAG:-latest}
    container_name: mandari-web
    restart: unless-stopped
    environment:
      # Database - connect to PRIMARY server
      DATABASE_URL: postgresql://${POSTGRES_USER:-mandari}:${POSTGRES_PASSWORD}@${MASTER_PRIVATE_IP:-10.0.0.3}:5432/${POSTGRES_DB:-mandari}
      # Cache - connect to PRIMARY server's Redis
      REDIS_URL: redis://${MASTER_PRIVATE_IP:-10.0.0.3}:6379
      # Search - local Meilisearch
      MEILISEARCH_URL: http://meilisearch:7700
      MEILISEARCH_KEY: ${MEILISEARCH_KEY}
      # Application
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: "false"
      ENVIRONMENT: production
      SITE_URL: ${SITE_URL}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS}
      # Encryption
      ENCRYPTION_MASTER_KEY: ${ENCRYPTION_MASTER_KEY}
      # AI (optional)
      NEBIUS_API_KEY: ${NEBIUS_API_KEY:-}
      # Server role
      SERVER_ROLE: standby
    networks:
      - mandari-network
    extra_hosts:
      - "primary-db:${MASTER_PRIVATE_IP:-10.0.0.3}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # NO INGESTOR ON STANDBY SERVER
  # ===========================================================================
  # The ingestor only runs on the primary server to avoid duplicate
  # data ingestion. After failover, the ingestor can be started manually
  # or via the failover script.

# =============================================================================
# Volumes
# =============================================================================
volumes:
  caddy_data:
  caddy_config:

# =============================================================================
# Networks
# =============================================================================
networks:
  mandari-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
