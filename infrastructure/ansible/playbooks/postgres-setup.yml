---
# =============================================================================
# Mandari 2.0 - PostgreSQL Replication Setup
# =============================================================================
# This playbook configures PostgreSQL streaming replication between
# the master (primary) and slave (replica) servers.
# =============================================================================

- name: Setup PostgreSQL Replication
  hosts: all_servers
  become: yes
  gather_facts: yes

  vars:
    postgres_data_dir: "{{ data_dir }}/postgres"
    postgres_conf_dir: "{{ app_dir }}/postgres"
    replication_user: "replicator"

  tasks:
    # =========================================================================
    # Common Setup
    # =========================================================================
    - name: Create PostgreSQL config directory
      file:
        path: "{{ postgres_conf_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Create scripts directory
      file:
        path: "{{ app_dir }}/scripts"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    # =========================================================================
    # PRIMARY Configuration (Master)
    # =========================================================================
    - name: Configure PostgreSQL Primary
      when: postgres_role == 'primary'
      block:
        - name: Create postgresql.conf for primary
          copy:
            dest: "{{ postgres_conf_dir }}/postgresql.conf"
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0644'
            content: |
              # =============================================================
              # Mandari PostgreSQL Configuration (Primary)
              # Optimized for 8GB RAM (cx31)
              # =============================================================

              # Connection Settings
              listen_addresses = '*'
              port = 5432
              max_connections = {{ postgres_max_connections }}

              # Memory Settings
              shared_buffers = {{ postgres_shared_buffers }}
              effective_cache_size = {{ postgres_effective_cache_size }}
              maintenance_work_mem = 512MB
              work_mem = 32MB
              wal_buffers = 64MB

              # Replication Settings
              wal_level = replica
              max_wal_senders = 5
              max_replication_slots = 5
              wal_keep_size = 1GB
              hot_standby = on
              hot_standby_feedback = on

              # Write Ahead Log
              synchronous_commit = on
              checkpoint_completion_target = 0.9
              max_wal_size = 4GB
              min_wal_size = 1GB

              # Query Planner
              random_page_cost = 1.1
              effective_io_concurrency = 200
              default_statistics_target = 100

              # Logging
              logging_collector = on
              log_directory = 'log'
              log_filename = 'postgresql-%Y-%m-%d.log'
              log_rotation_age = 1d
              log_rotation_size = 100MB
              log_min_duration_statement = 1000
              log_checkpoints = on
              log_connections = on
              log_disconnections = on
              log_lock_waits = on

              # Extensions
              shared_preload_libraries = 'pg_stat_statements'
              pg_stat_statements.track = all
              pg_stat_statements.max = 10000

              # Locale
              lc_messages = 'en_US.UTF-8'
              lc_monetary = 'de_DE.UTF-8'
              lc_numeric = 'de_DE.UTF-8'
              lc_time = 'de_DE.UTF-8'

        - name: Create pg_hba.conf for primary
          copy:
            dest: "{{ postgres_conf_dir }}/pg_hba.conf"
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0644'
            content: |
              # TYPE  DATABASE        USER            ADDRESS                 METHOD

              # Local connections
              local   all             all                                     trust
              host    all             all             127.0.0.1/32            scram-sha-256
              host    all             all             ::1/128                 scram-sha-256

              # Docker network
              host    all             all             172.16.0.0/12           scram-sha-256

              # Private network (Mandari)
              host    all             all             10.0.0.0/16             scram-sha-256

              # Replication connections from replica
              host    replication     {{ replication_user }}    {{ slave_private_ip }}/32       scram-sha-256
              host    replication     {{ replication_user }}    10.0.0.0/16             scram-sha-256

        - name: Create init script for replication user
          copy:
            dest: "{{ postgres_conf_dir }}/init-replication.sql"
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0644'
            content: |
              -- Create replication user
              DO $$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '{{ replication_user }}') THEN
                  CREATE ROLE {{ replication_user }} WITH REPLICATION LOGIN PASSWORD '{{ lookup("env", "REPLICATION_PASSWORD") }}';
                END IF;
              END
              $$;

              -- Create replication slot for replica
              SELECT * FROM pg_create_physical_replication_slot('replica_slot', true)
              WHERE NOT EXISTS (SELECT 1 FROM pg_replication_slots WHERE slot_name = 'replica_slot');

              -- Enable pg_stat_statements
              CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

    # =========================================================================
    # REPLICA Configuration (Slave)
    # =========================================================================
    - name: Configure PostgreSQL Replica
      when: postgres_role == 'replica'
      block:
        - name: Create postgresql.conf for replica
          copy:
            dest: "{{ postgres_conf_dir }}/postgresql.conf"
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0644'
            content: |
              # =============================================================
              # Mandari PostgreSQL Configuration (Replica)
              # =============================================================

              # Connection Settings
              listen_addresses = '*'
              port = 5432
              max_connections = {{ postgres_max_connections }}

              # Memory Settings (same as primary)
              shared_buffers = {{ postgres_shared_buffers }}
              effective_cache_size = {{ postgres_effective_cache_size }}
              maintenance_work_mem = 512MB
              work_mem = 32MB

              # Hot Standby Settings
              hot_standby = on
              hot_standby_feedback = on
              max_standby_streaming_delay = 30s
              max_standby_archive_delay = 30s
              wal_receiver_status_interval = 10s

              # Primary Connection
              primary_conninfo = 'host={{ master_private_ip }} port=5432 user={{ replication_user }} password={{ lookup("env", "REPLICATION_PASSWORD") }} application_name=replica'
              primary_slot_name = 'replica_slot'

              # Query Planner
              random_page_cost = 1.1
              effective_io_concurrency = 200

              # Logging
              logging_collector = on
              log_directory = 'log'
              log_filename = 'postgresql-%Y-%m-%d.log'

              # Extensions
              shared_preload_libraries = 'pg_stat_statements'

        - name: Create pg_hba.conf for replica
          copy:
            dest: "{{ postgres_conf_dir }}/pg_hba.conf"
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0644'
            content: |
              # TYPE  DATABASE        USER            ADDRESS                 METHOD

              # Local connections
              local   all             all                                     trust
              host    all             all             127.0.0.1/32            scram-sha-256
              host    all             all             ::1/128                 scram-sha-256

              # Docker network
              host    all             all             172.16.0.0/12           scram-sha-256

              # Private network (Mandari)
              host    all             all             10.0.0.0/16             scram-sha-256

        - name: Create standby.signal file
          copy:
            dest: "{{ postgres_conf_dir }}/standby.signal"
            content: ""
            owner: "{{ app_user }}"
            group: "{{ app_user }}"
            mode: '0644'

    # =========================================================================
    # Initialization Scripts
    # =========================================================================
    - name: Create base backup script for replica initialization
      when: postgres_role == 'replica'
      copy:
        dest: "{{ app_dir }}/scripts/init-replica.sh"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
        content: |
          #!/bin/bash
          set -euo pipefail

          # Mandari PostgreSQL Replica Initialization Script
          # Run this to initialize the replica from the primary

          DATA_DIR="{{ postgres_data_dir }}"
          PRIMARY_HOST="{{ master_private_ip }}"
          REPLICATION_USER="{{ replication_user }}"

          echo "=== Initializing PostgreSQL Replica ==="

          # Stop PostgreSQL if running
          echo "Stopping PostgreSQL container..."
          docker compose -f {{ app_dir }}/docker-compose.yml stop postgres || true

          # Clear data directory
          echo "Clearing data directory..."
          sudo rm -rf "$DATA_DIR"/*

          # Run pg_basebackup
          echo "Running pg_basebackup from primary..."
          docker run --rm \
            -v "$DATA_DIR":/var/lib/postgresql/data \
            -e PGPASSWORD="${REPLICATION_PASSWORD}" \
            --network host \
            postgres:{{ postgres_version }}-alpine \
            pg_basebackup \
              -h "$PRIMARY_HOST" \
              -p 5432 \
              -U "$REPLICATION_USER" \
              -D /var/lib/postgresql/data \
              -Fp -Xs -P -R \
              -S replica_slot

          # Copy configuration files
          echo "Copying configuration files..."
          cp {{ postgres_conf_dir }}/postgresql.conf "$DATA_DIR/"
          cp {{ postgres_conf_dir }}/pg_hba.conf "$DATA_DIR/"
          cp {{ postgres_conf_dir }}/standby.signal "$DATA_DIR/"

          # Set permissions
          sudo chown -R 999:999 "$DATA_DIR"

          # Start PostgreSQL
          echo "Starting PostgreSQL container..."
          docker compose -f {{ app_dir }}/docker-compose.yml up -d postgres

          echo "=== Replica initialization complete ==="
          echo "Check replication status with: docker exec mandari-postgres psql -U mandari -c 'SELECT * FROM pg_stat_wal_receiver;'"

    - name: Create replication status check script
      copy:
        dest: "{{ app_dir }}/scripts/check-replication.sh"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
        content: |
          #!/bin/bash
          # Check PostgreSQL replication status

          if [ "{{ postgres_role }}" == "primary" ]; then
            echo "=== Primary Replication Status ==="
            docker exec mandari-postgres psql -U mandari -c "
              SELECT
                client_addr,
                state,
                sent_lsn,
                write_lsn,
                flush_lsn,
                replay_lsn,
                pg_size_pretty(pg_wal_lsn_diff(sent_lsn, replay_lsn)) as replication_lag
              FROM pg_stat_replication;
            "
            echo ""
            echo "=== Replication Slots ==="
            docker exec mandari-postgres psql -U mandari -c "
              SELECT slot_name, active, restart_lsn, pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) as slot_lag
              FROM pg_replication_slots;
            "
          else
            echo "=== Replica Status ==="
            docker exec mandari-postgres psql -U mandari -c "
              SELECT
                status,
                received_lsn,
                latest_end_lsn,
                slot_name,
                sender_host,
                conninfo
              FROM pg_stat_wal_receiver;
            "
            echo ""
            echo "=== Recovery Status ==="
            docker exec mandari-postgres psql -U mandari -c "SELECT pg_is_in_recovery(), pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn();"
          fi

