---
# =============================================================================
# Mandari 2.0 - Initial Server Setup Playbook
# =============================================================================
# This playbook configures newly provisioned servers with:
# - System updates and security hardening
# - Docker and Docker Compose installation
# - Deploy user creation
# - Firewall configuration
# - Volume mounting
# =============================================================================

- name: Initial Server Setup
  hosts: all_servers
  become: yes
  gather_facts: yes

  vars:
    required_packages:
      - curl
      - wget
      - gnupg
      - lsb-release
      - ca-certificates
      - apt-transport-https
      - software-properties-common
      - ufw
      - fail2ban
      - htop
      - vim
      - git
      - jq
      - unzip
      - rsync
      - python3-pip
      - python3-docker

  handlers:
    - name: restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: restart docker
      systemd:
        name: docker
        state: restarted

  tasks:
    # =========================================================================
    # System Updates
    # =========================================================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Install required packages
      apt:
        name: "{{ required_packages }}"
        state: present

    # =========================================================================
    # Security Hardening
    # =========================================================================
    - name: Configure SSH - Disable root password login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin prohibit-password"
      notify: restart sshd

    - name: Configure SSH - Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
      notify: restart sshd

    - name: Configure fail2ban
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 5

          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 3
      notify: restart fail2ban

    - name: Enable fail2ban
      systemd:
        name: fail2ban
        enabled: yes
        state: started

    # =========================================================================
    # Firewall Configuration
    # =========================================================================
    - name: Reset UFW to default
      ufw:
        state: reset

    - name: Allow SSH
      ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Allow HTTP
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Allow HTTPS
      ufw:
        rule: allow
        port: "443"
        proto: tcp

    - name: Allow PostgreSQL from private network
      ufw:
        rule: allow
        port: "5432"
        proto: tcp
        from_ip: "{{ private_network_cidr }}"

    - name: Allow Redis from private network
      ufw:
        rule: allow
        port: "6379"
        proto: tcp
        from_ip: "{{ private_network_cidr }}"

    - name: Allow pgBouncer from private network
      ufw:
        rule: allow
        port: "6432"
        proto: tcp
        from_ip: "{{ private_network_cidr }}"

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    - name: Allow outgoing traffic
      ufw:
        direction: outgoing
        policy: allow

    # =========================================================================
    # Docker Installation
    # =========================================================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      notify: restart docker

    - name: Enable Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Configure Docker daemon
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "50m",
              "max-file": "3"
            },
            "storage-driver": "overlay2",
            "live-restore": true
          }
      notify: restart docker

    # =========================================================================
    # Deploy User
    # =========================================================================
    - name: Create deploy user
      user:
        name: "{{ app_user }}"
        groups: docker,sudo
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Set up SSH key for deploy user
      authorized_key:
        user: "{{ app_user }}"
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
        state: present

    - name: Allow deploy user passwordless sudo for docker
      lineinfile:
        path: /etc/sudoers.d/deploy
        line: "{{ app_user }} ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose, /usr/bin/systemctl"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    # =========================================================================
    # Application Directory
    # =========================================================================
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Create subdirectories
      file:
        path: "{{ app_dir }}/{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      loop:
        - postgres
        - redis
        - meilisearch
        - caddy
        - logs
        - backups

    # =========================================================================
    # Data Volume Mount
    # =========================================================================
    - name: Create data mount point
      file:
        path: "{{ data_dir }}"
        state: directory
        mode: '0755'

    - name: Check if volume is already mounted
      shell: mountpoint -q {{ data_dir }} && echo "mounted" || echo "not_mounted"
      register: mount_status
      changed_when: false

    - name: Find attached volume device
      shell: lsblk -o NAME,SIZE,MOUNTPOINT -n | grep -v "loop\|sda" | head -1 | awk '{print "/dev/"$1}'
      register: volume_device
      when: mount_status.stdout == "not_mounted"
      changed_when: false

    - name: Mount data volume
      mount:
        path: "{{ data_dir }}"
        src: "{{ volume_device.stdout }}"
        fstype: ext4
        opts: defaults,noatime
        state: mounted
      when:
        - mount_status.stdout == "not_mounted"
        - volume_device.stdout is defined
        - volume_device.stdout | length > 0

    - name: Create data subdirectories
      file:
        path: "{{ data_dir }}/{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      loop:
        - postgres
        - redis
        - meilisearch
        - ingestor

    # =========================================================================
    # System Tuning
    # =========================================================================
    - name: Configure sysctl for performance
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - { name: 'vm.swappiness', value: '10' }
        - { name: 'vm.overcommit_memory', value: '1' }
        - { name: 'net.core.somaxconn', value: '65535' }
        - { name: 'net.ipv4.tcp_max_syn_backlog', value: '65535' }
        - { name: 'net.ipv4.ip_local_port_range', value: '1024 65535' }
        - { name: 'fs.file-max', value: '2097152' }

    - name: Configure limits
      pam_limits:
        domain: '*'
        limit_type: "{{ item.type }}"
        limit_item: nofile
        value: "{{ item.value }}"
      loop:
        - { type: 'soft', value: '65536' }
        - { type: 'hard', value: '65536' }

    # =========================================================================
    # Cleanup
    # =========================================================================
    - name: Remove unnecessary packages
      apt:
        name:
          - snapd
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Clean apt cache
      apt:
        autoclean: yes
        autoremove: yes

    - name: Final reboot to apply all changes
      reboot:
        msg: "Rebooting to apply system changes"
        reboot_timeout: 300
      when: ansible_facts['virtualization_type'] != 'docker'
