---
# =============================================================================
# Mandari 2.0 - Application Deployment Playbook
# =============================================================================
# This playbook deploys the Mandari application to the servers.
# It handles:
# - Environment configuration
# - Docker image building/pulling
# - Container orchestration
# - Health checks
# =============================================================================

- name: Deploy Mandari Application
  hosts: all_servers
  become: yes
  gather_facts: yes

  vars:
    compose_file: "{{ 'docker-compose.master.yml' if postgres_role == 'primary' else 'docker-compose.slave.yml' }}"
    deploy_timestamp: "{{ ansible_facts['date_time']['epoch'] }}"

  handlers:
    - name: restart containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        state: present
        pull: always

  tasks:
    # =========================================================================
    # Prepare Deployment
    # =========================================================================
    - name: Create backup of current deployment
      archive:
        path: "{{ app_dir }}"
        dest: "{{ app_dir }}/backups/deploy-{{ deploy_timestamp }}.tar.gz"
        exclude_path:
          - "{{ app_dir }}/backups"
          - "{{ data_dir }}"
      ignore_errors: yes

    - name: Ensure app directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/backups"
        - "{{ app_dir }}/logs"
        - "{{ app_dir }}/config"

    - name: Ensure data directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      loop:
        - "{{ data_dir }}"
        - "{{ data_dir }}/postgres"
        - "{{ data_dir }}/redis"
        - "{{ data_dir }}/meilisearch"
        - "{{ data_dir }}/ingestor"

    - name: Sync Docker Compose files
      copy:
        src: "{{ playbook_dir }}/../../docker/{{ item }}"
        dest: "{{ app_dir }}/{{ item }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      loop:
        - docker-compose.master.yml
        - docker-compose.slave.yml
        - Caddyfile
        - pg_hba.conf

    - name: Sync environment file
      copy:
        src: "{{ playbook_dir }}/../../docker/.env"
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'

    - name: Create Docker Compose symlink
      file:
        src: "{{ app_dir }}/{{ compose_file }}"
        dest: "{{ app_dir }}/docker-compose.yml"
        state: link
        force: yes

    # =========================================================================
    # Docker Registry Authentication
    # =========================================================================
    - name: Login to GitHub Container Registry
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ ghcr_username }}"
        password: "{{ ghcr_token }}"
      when: ghcr_token is defined and ghcr_token | length > 0

    # =========================================================================
    # Deploy Containers
    # =========================================================================
    - name: Pull latest images
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        pull: always
      ignore_errors: yes

    - name: Start all containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        state: present
        recreate: always
      register: compose_result
      ignore_errors: yes

    - name: Wait for containers to stabilize
      pause:
        seconds: 15

    - name: Get pgbouncer logs (for debugging)
      shell: docker logs mandari-pgbouncer --tail 50 2>&1
      register: pgbouncer_logs
      ignore_errors: yes

    - name: Display pgbouncer logs
      debug:
        msg: "{{ pgbouncer_logs.stdout_lines }}"
      when: pgbouncer_logs.stdout_lines is defined

    - name: Get API container logs (for debugging)
      shell: docker logs mandari-api --tail 100 2>&1
      register: api_logs
      ignore_errors: yes

    - name: Display API logs
      debug:
        msg: "{{ api_logs.stdout_lines }}"
      when: api_logs.stdout_lines is defined

    - name: Check container status
      shell: docker ps -a --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.State{{ '}}' }}"
      register: container_status

    - name: Display container status
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Fail if API is not running
      shell: docker inspect mandari-api --format '{{ '{{' }}.State.Running{{ '}}' }}'
      register: api_running
      failed_when: api_running.stdout != 'true'

    - name: Display deployment result
      debug:
        msg: "Deployment completed. Containers: {{ compose_result.containers | map(attribute='Name') | list }}"
      when: compose_result.containers is defined

    # =========================================================================
    # Database Migrations (Primary only)
    # =========================================================================
    - name: Run database migrations
      when: postgres_role == 'primary'
      block:
        - name: Wait for PostgreSQL to be ready
          community.docker.docker_container_exec:
            container: mandari-postgres
            command: pg_isready -U mandari
          register: pg_ready
          retries: 30
          delay: 2
          until: pg_ready.rc == 0

        - name: Run migrations
          community.docker.docker_container_exec:
            container: mandari-api
            command: python manage.py migrate --noinput
          register: migration_result

        - name: Display migration result
          debug:
            msg: "{{ migration_result.stdout }}"

        - name: Setup Django roles and permissions
          community.docker.docker_container_exec:
            container: mandari-api
            command: python manage.py setup_roles
          register: roles_result
          ignore_errors: yes

    # =========================================================================
    # Health Checks
    # =========================================================================
    - name: Wait for API container to be healthy
      shell: docker inspect --format='{{'{{'}}.State.Health.Status{{'}}'}}' mandari-api
      register: api_health
      retries: 30
      delay: 5
      until: api_health.stdout == 'healthy'
      ignore_errors: yes

    - name: Wait for Caddy health check
      uri:
        url: "http://localhost/health"
        method: GET
        status_code: 200
      register: caddy_health
      retries: 30
      delay: 5
      until: caddy_health.status == 200

    # =========================================================================
    # Cleanup
    # =========================================================================
    - name: Remove old Docker images
      shell: docker image prune -f --filter "until=24h"
      ignore_errors: yes

    - name: Remove old backups (keep last 5)
      shell: |
        cd {{ app_dir }}/backups && \
        ls -t deploy-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm --
      ignore_errors: yes

  post_tasks:
    - name: Display deployment summary
      debug:
        msg: |
          ==========================================
          Deployment Complete!
          ==========================================
          Server: {{ inventory_hostname }}
          Role: {{ postgres_role }}
          Compose File: {{ compose_file }}
          Timestamp: {{ deploy_timestamp }}
          ==========================================

# =============================================================================
# Verify Deployment
# =============================================================================
- name: Verify Deployment
  hosts: all_servers
  become: yes
  gather_facts: no

  tasks:
    - name: Check running containers
      shell: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: docker_ps

    - name: Display running containers
      debug:
        msg: "{{ docker_ps.stdout_lines }}"

    - name: Check container health
      shell: docker inspect --format='{{'{{'}}.State.Health.Status{{'}}'}}' {{ item }}
      loop:
        - mandari-postgres
        - mandari-redis
        - mandari-api
      register: health_status
      ignore_errors: yes

    - name: Verify PostgreSQL replication (primary)
      when: postgres_role == 'primary'
      shell: docker exec mandari-postgres psql -U mandari -t -c "SELECT count(*) FROM pg_stat_replication;"
      register: replication_count

    - name: Display replication status (primary)
      when: postgres_role == 'primary'
      debug:
        msg: "Connected replicas: {{ replication_count.stdout | trim }}"

    - name: Verify PostgreSQL replication (replica)
      when: postgres_role == 'replica'
      shell: docker exec mandari-postgres psql -U mandari -t -c "SELECT pg_is_in_recovery();"
      register: recovery_status

    - name: Display recovery status (replica)
      when: postgres_role == 'replica'
      debug:
        msg: "In recovery mode: {{ recovery_status.stdout | trim }}"
