---
# =============================================================================
# Mandari 2.0 - Application Deployment Playbook
# =============================================================================
# IMPORTANT: Master is deployed FIRST, then Slave
# This ensures migrations run before slave connects to master DB
#
# This playbook is SELF-CONTAINED and includes:
# - Docker installation (if not present)
# - User creation (if not present)
# - Directory setup
# - Container deployment
# =============================================================================

# =============================================================================
# PHASE 0: Bootstrap All Servers (Docker, Users, Directories)
# =============================================================================
- name: Bootstrap Servers
  hosts: all_servers
  become: yes
  gather_facts: yes

  tasks:
    # =========================================================================
    # Install Docker (if not present)
    # =========================================================================
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-pip
          - python3-docker
        state: present
        update_cache: yes
      when: docker_check.rc != 0

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      when: docker_check.rc != 0

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
      when: docker_check.rc != 0

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      when: docker_check.rc != 0

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    # =========================================================================
    # Create deploy user (if not present)
    # =========================================================================
    - name: Check if deploy user exists
      getent:
        database: passwd
        key: "{{ app_user }}"
      register: user_check
      ignore_errors: yes

    - name: Create deploy user
      user:
        name: "{{ app_user }}"
        groups: docker
        shell: /bin/bash
        create_home: yes
        state: present
      when: user_check.failed | default(false)

    - name: Add deploy user to docker group (ensure)
      user:
        name: "{{ app_user }}"
        groups: docker
        append: yes

    # =========================================================================
    # Create directories (as root, then chown)
    # =========================================================================
    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/backups"
        - "{{ app_dir }}/scripts"
        - "{{ data_dir }}"
        - "{{ data_dir }}/postgres"
        - "{{ data_dir }}/redis"
        - "{{ data_dir }}/meilisearch"

    - name: Create ingestor data directory (master only)
      file:
        path: "{{ data_dir }}/ingestor"
        state: directory
        mode: '0755'
      when: run_ingestor | default(false)

    - name: Set directory ownership
      file:
        path: "{{ item }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: no
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/backups"
        - "{{ app_dir }}/scripts"
      ignore_errors: yes

# =============================================================================
# PHASE 1: Deploy Master (Primary)
# =============================================================================
- name: Deploy Master Server
  hosts: master
  become: yes
  gather_facts: yes
  serial: 1

  vars:
    compose_file: "docker-compose.master.yml"
    deploy_timestamp: "{{ ansible_facts['date_time']['epoch'] }}"

  tasks:
    # =========================================================================
    # Cleanup & Prepare
    # =========================================================================
    - name: Stop all existing containers
      shell: |
        cd {{ app_dir }} && docker compose down --remove-orphans -v 2>/dev/null || true
        docker ps -a --filter "name=mandari-" -q | xargs -r docker rm -f 2>/dev/null || true
      ignore_errors: yes

    - name: Sync Docker Compose files
      copy:
        src: "{{ playbook_dir }}/../../docker/{{ item }}"
        dest: "{{ app_dir }}/{{ item }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      loop:
        - docker-compose.master.yml
        - docker-compose.slave.yml
        - Caddyfile
        - pg_hba.conf

    - name: Sync environment file
      copy:
        src: "{{ playbook_dir }}/../../docker/.env"
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'

    - name: Create Docker Compose symlink
      file:
        src: "{{ app_dir }}/{{ compose_file }}"
        dest: "{{ app_dir }}/docker-compose.yml"
        state: link
        force: yes

    # =========================================================================
    # PostgreSQL Reinitialization (if requested)
    # =========================================================================
    - name: Check if PostgreSQL needs reinitialization
      stat:
        path: "{{ data_dir }}/postgres/PG_VERSION"
      register: pg_data_exists

    - name: Clear PostgreSQL data for reinitialization
      file:
        path: "{{ data_dir }}/postgres"
        state: absent
      when: force_postgres_reinit | default(false) | bool

    - name: Recreate PostgreSQL data directory
      file:
        path: "{{ data_dir }}/postgres"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      when: force_postgres_reinit | default(false) | bool

    # =========================================================================
    # Docker Registry & Pull
    # =========================================================================
    - name: Login to GitHub Container Registry
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ ghcr_username }}"
        password: "{{ ghcr_token }}"
      when: ghcr_token is defined and ghcr_token | length > 0

    - name: Pull latest images
      shell: cd {{ app_dir }} && docker compose -f {{ compose_file }} pull
      ignore_errors: yes

    # =========================================================================
    # Start Containers
    # =========================================================================
    - name: Start all containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        state: present
        recreate: always
        remove_orphans: true
      register: compose_result

    - name: Wait for PostgreSQL to be healthy
      shell: |
        for i in {1..30}; do
          docker exec mandari-postgres pg_isready -U mandari && exit 0
          sleep 2
        done
        exit 1
      register: pg_ready
      retries: 3
      delay: 5
      until: pg_ready.rc == 0

    - name: Wait for API to start
      pause:
        seconds: 10

    # =========================================================================
    # Run Migrations (Master Only)
    # =========================================================================
    - name: Run database migrations
      community.docker.docker_container_exec:
        container: mandari-api
        command: python manage.py migrate --noinput
      register: migration_result
      retries: 3
      delay: 10
      until: migration_result.rc == 0

    - name: Display migration result
      debug:
        msg: "{{ migration_result.stdout }}"

    - name: Setup Django roles and permissions
      community.docker.docker_container_exec:
        container: mandari-api
        command: python manage.py setup_roles
      ignore_errors: yes

    # =========================================================================
    # Health Check
    # =========================================================================
    - name: Wait for API to be healthy
      shell: docker inspect --format='{{.State.Health.Status}}' mandari-api
      register: api_health
      retries: 30
      delay: 5
      until: api_health.stdout == 'healthy'

    - name: Master deployment complete
      debug:
        msg: "✅ Master deployment complete. Migrations applied."

# =============================================================================
# PHASE 2: Deploy Slave (Replica) - AFTER Master is ready
# =============================================================================
- name: Deploy Slave Server
  hosts: slave
  become: yes
  gather_facts: yes
  serial: 1

  vars:
    compose_file: "docker-compose.slave.yml"
    deploy_timestamp: "{{ ansible_facts['date_time']['epoch'] }}"

  tasks:
    # =========================================================================
    # Cleanup & Prepare
    # =========================================================================
    - name: Stop all existing containers
      shell: |
        cd {{ app_dir }} && docker compose down --remove-orphans -v 2>/dev/null || true
        docker ps -a --filter "name=mandari-" -q | xargs -r docker rm -f 2>/dev/null || true
      ignore_errors: yes

    - name: Sync Docker Compose files
      copy:
        src: "{{ playbook_dir }}/../../docker/{{ item }}"
        dest: "{{ app_dir }}/{{ item }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      loop:
        - docker-compose.master.yml
        - docker-compose.slave.yml
        - Caddyfile
        - pg_hba.conf

    - name: Sync environment file
      copy:
        src: "{{ playbook_dir }}/../../docker/.env"
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'

    - name: Create Docker Compose symlink
      file:
        src: "{{ app_dir }}/{{ compose_file }}"
        dest: "{{ app_dir }}/docker-compose.yml"
        state: link
        force: yes

    # =========================================================================
    # PostgreSQL Reinitialization (if requested)
    # =========================================================================
    - name: Clear PostgreSQL data for reinitialization
      file:
        path: "{{ data_dir }}/postgres"
        state: absent
      when: force_postgres_reinit | default(false) | bool

    - name: Recreate PostgreSQL data directory
      file:
        path: "{{ data_dir }}/postgres"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      when: force_postgres_reinit | default(false) | bool

    # =========================================================================
    # Docker Registry & Pull
    # =========================================================================
    - name: Login to GitHub Container Registry
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ ghcr_username }}"
        password: "{{ ghcr_token }}"
      when: ghcr_token is defined and ghcr_token | length > 0

    - name: Pull latest images
      shell: cd {{ app_dir }} && docker compose -f {{ compose_file }} pull
      ignore_errors: yes

    # =========================================================================
    # Start Containers
    # =========================================================================
    - name: Start all containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        state: present
        recreate: always
        remove_orphans: true

    # =========================================================================
    # Health Check
    # =========================================================================
    - name: Wait for API to be healthy
      shell: docker inspect --format='{{.State.Health.Status}}' mandari-api
      register: api_health
      retries: 30
      delay: 5
      until: api_health.stdout == 'healthy'
      ignore_errors: yes

    - name: Slave deployment complete
      debug:
        msg: "✅ Slave deployment complete."

# =============================================================================
# PHASE 3: Final Verification
# =============================================================================
- name: Verify Deployment
  hosts: all_servers
  become: yes
  gather_facts: no

  tasks:
    - name: Check running containers
      shell: docker ps --format "table {{'{{'}}.Names{{'}}'}}\\t{{'{{'}}.Status{{'}}'}}\\t{{'{{'}}.Ports{{'}}'}}"
      register: docker_ps

    - name: Display running containers
      debug:
        msg: "{{ docker_ps.stdout_lines }}"

    - name: Final health check
      uri:
        url: "http://localhost/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 5
      delay: 5
      until: health_check.status == 200
      ignore_errors: yes

    - name: Deployment summary
      debug:
        msg: |
          ==========================================
          Deployment Complete!
          ==========================================
          Server: {{ inventory_hostname }}
          Role: {{ postgres_role }}
          Health: {{ 'OK' if health_check.status == 200 else 'FAILED' }}
          ==========================================
